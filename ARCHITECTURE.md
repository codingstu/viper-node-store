# ç³»ç»Ÿæž¶æž„è¯´æ˜Ž

## ðŸ“Š å®Œæ•´æž¶æž„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GitHub Actions (æ¯ 4 å°æ—¶)                    â”‚
â”‚  Trigger: schedule (0 */4 * * *) OR workflow_dispatch            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ðŸ“¡ fetch_nodes_from_api â”‚
        â”‚  ä»Ž SHADOW_VIPER_API èŽ·å– â”‚
        â”‚  åŽŸå§‹èŠ‚ç‚¹åˆ—è¡¨             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ðŸ·ï¸  èŠ‚ç‚¹åˆ†ç±»                 â”‚
        â”‚  æŒ‰ country å­—æ®µåˆ†ç±»:         â”‚
        â”‚  - CN â†’ å¤§é™†èŠ‚ç‚¹             â”‚
        â”‚  - HK/TW/MO â†’ å›žå›½èŠ‚ç‚¹       â”‚
        â”‚  - å…¶ä»–/æ— æ ‡è®° â†’ å›½å¤–èŠ‚ç‚¹    â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚   â”‚              â”‚
        â–¼             â–¼   â–¼              â–¼
    ðŸ‡¨ðŸ‡³ CN èŠ‚ç‚¹    ðŸŒ å›žå›½èŠ‚ç‚¹    ðŸŒ å›½å¤–èŠ‚ç‚¹
        â”‚              â”‚              â”‚
        â”‚ (åŒä¸€é˜Ÿåˆ—)   â”‚ (åŒä¸€é˜Ÿåˆ—)   â”‚
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
    âš™ï¸ Aliyun FC  ðŸŒ Cloudflare  ðŸŒ Cloudflare
    (å¤§é™†æµ‹é€Ÿ)   Workers(å›½å¤–æµ‹é€Ÿ)
        â”‚              â”‚
        â”‚              â”‚
        â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ðŸ“Š æµ‹é€Ÿç»“æžœåˆå¹¶                â”‚
    â”‚  - æˆåŠŸèŠ‚ç‚¹ â†’ ä¿å­˜              â”‚
    â”‚  - å¤±è´¥èŠ‚ç‚¹ â†’ ä¸¢å¼ƒ              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ðŸ’¾ save_to_supabase()          â”‚
    â”‚  - åŽ»é‡ (host:port ID)         â”‚
    â”‚  - æ‰¹é‡ä¿å­˜ (50 æ¡/æ‰¹)         â”‚
    â”‚  - æ ‡è®° is_free (å‰ 15 ä¸ª)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ðŸ“Š Supabase æ•°æ®åº“            â”‚
    â”‚  è¡¨: nodes                      â”‚
    â”‚  - id (host:port)             â”‚
    â”‚  - content (å®Œæ•´èŠ‚ç‚¹)          â”‚
    â”‚  - speed (1-50)               â”‚
    â”‚  - latency (ms)               â”‚
    â”‚  - quality_score              â”‚
    â”‚  - is_free (true/false)       â”‚
    â”‚  - test_via (aliyun/cf)      â”‚
    â”‚  - updated_at                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ðŸŒ å‰ç«¯ç½‘é¡µ (index.html)      â”‚
    â”‚  æŒ‰éœ€åˆ·æ–°: fetchData()          â”‚
    â”‚  - ç¦ç”¨ç¼“å­˜ (cache: no-store)  â”‚
    â”‚  - æ—¶é—´æˆ³ (?t=timestamp)       â”‚
    â”‚  - æ˜¾ç¤ºæµ‹é€ŸåŽçš„èŠ‚ç‚¹             â”‚
    â”‚  - å…è´¹ç”¨æˆ·: å‰ 20 ä¸ª           â”‚
    â”‚  - VIP ç”¨æˆ·: å…¨éƒ¨              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”§ å…³é”®é…ç½®

### çŽ¯å¢ƒå˜é‡ (GitHub Secrets)

| å˜é‡å | å«ä¹‰ | ä¾‹å€¼ |
|--------|------|------|
| `SHADOW_VIPER_API` | èŠ‚ç‚¹ API | `https://api.example.com/nodes` |
| `SUPABASE_URL` | Supabase URL | `https://xxx.supabase.co` |
| `SUPABASE_KEY` | Supabase anon key | `eyJ...` |
| `ALIYUN_FC_URL` | é˜¿é‡Œäº‘å¤§é™†æµ‹é€Ÿ | `https://xxx.cn-hangzhou.fcapp.run` |
| `CLOUDFLARE_WORKER_URL` | Cloudflare å›½å¤–æµ‹é€Ÿ | `https://xxx.workers.dev` |

### Python è„šæœ¬æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `update_nodes.py` | ä¸»è¿è¡Œè„šæœ¬ (GitHub Actions æ‰§è¡Œ) |
| `.github/workflows/update-nodes.yml` | å·¥ä½œæµå®šä¹‰ |

### Aliyun Function Compute

| å‚æ•° | å€¼ |
|------|-----|
| å‡½æ•°å | (è‡ªå®šä¹‰) |
| è¿è¡Œæ—¶ | Python 3.10/3.11 |
| å†…å­˜ | 128MB |
| è¶…æ—¶ | 60s |
| çŽ¯å¢ƒ | Web Function (HTTP Server) |
| å¯åŠ¨å‘½ä»¤ | `python3 main.py` |
| éƒ¨ç½²ä»£ç  | `aliyun_fc_main.py` |

### Cloudflare Worker

| å‚æ•° | å€¼ |
|------|-----|
| è„šæœ¬ | `cloudflare_worker.js` |
| çŽ¯å¢ƒ | Service Worker |
| è¶…æ—¶ | 30s (Cloudflare é™åˆ¶) |
| å¹¶å‘ | æ”¯æŒ Promise.all() å¹¶å‘æµ‹è¯• |

---

## ðŸ”„ æ•°æ®æµè½¬

### 1ï¸âƒ£ èŠ‚ç‚¹æå– (API â†’ æœ¬åœ°)

```python
# ä¼˜å…ˆçº§: æœ¬åœ°æ–‡ä»¶ > è¿œç¨‹ API
1. å°è¯•è¯»å– public/nodes.json
2. å¤±è´¥åˆ™ä»Ž SHADOW_VIPER_API èŽ·å–
3. è¿”å›ž List[Dict]
```

**ç½‘ç»œæ–¹æ¡ˆ:**
- æ€»è¶…æ—¶: 180s
- è¿žæŽ¥è¶…æ—¶: 60s
- è¯»å–è¶…æ—¶: 120s
- é‡è¯•æ¬¡æ•°: 3 æ¬¡ (é—´éš” 5s)

### 2ï¸âƒ£ èŠ‚ç‚¹åˆ†ç±» (æŒ‰å›½å®¶)

```python
# country å­—æ®µè¯´æ˜Ž
if node.get('country') == 'CN':
    # å¤§é™†èŠ‚ç‚¹ â†’ Aliyun FC æµ‹é€Ÿ
    test_via_aliyun()
else:
    # å›žå›½/å›½å¤–èŠ‚ç‚¹ â†’ Cloudflare Workers æµ‹é€Ÿ
    test_nodes_via_cloudflare()
```

### 3ï¸âƒ£ å¹¶å‘æµ‹é€Ÿ (æ‰¹é‡å¤„ç†)

**å¤§é™† (Aliyun FC):**
- æ‰¹å¤§å°: 15 ä¸ªèŠ‚ç‚¹/æ‰¹
- æ‰¹é—´éš”: 0.5s (é¿å…é¢‘çŽ‡é™åˆ¶)
- å•èŠ‚ç‚¹è¶…æ—¶: 2.5s (TCP æ¡æ‰‹)
- æ‰¹è¶…æ—¶: 20s

**å›½å¤– (Cloudflare):**
- æ‰¹å¤§å°: 15 ä¸ªèŠ‚ç‚¹/æ‰¹
- æ‰¹é—´éš”: 0.5s
- å•èŠ‚ç‚¹è¶…æ—¶: 2.5s (HTTP HEAD)
- æ‰¹è¶…æ—¶: 20s
- å¹¶å‘: Promise.all() (å…¨éƒ¨å¹¶è¡Œ)

### 4ï¸âƒ£ ç»“æžœè¿‡æ»¤

```python
# åªä¿å­˜æˆåŠŸçš„èŠ‚ç‚¹
if result['success']:
    # è®¡ç®—è¯„åˆ†
    quality_score = calculate_score(latency)
    # æ ‡è®°æµ‹è¯•æ¥æº
    node['test_via'] = 'aliyun' or 'cloudflare'
    # ä¿å­˜
    save_to_supabase(node)
```

### 5ï¸âƒ£ æ•°æ®ä¿å­˜ (Supabase)

```python
# åŽ»é‡æœºåˆ¶
seen_ids = set()
for node in results:
    node_id = f"{node['host']}:{node['port']}"
    if node_id in seen_ids:
        continue  # è·³è¿‡é‡å¤
    seen_ids.add(node_id)

# æ‰¹é‡å†™å…¥
batch_size = 50
supabase.table("nodes").upsert(batch).execute()
```

### 6ï¸âƒ£ å‰ç«¯æ˜¾ç¤º (åˆ·æ–°æœºåˆ¶)

```javascript
// ç¦ç”¨ç¼“å­˜
const response = await fetch(url, {
    cache: 'no-store',  // ä¸ç”¨ç¼“å­˜
    headers: { 'Cache-Control': 'no-cache' }
});

// åŠ æ—¶é—´æˆ³å‚æ•°
const timestamp = new Date().getTime();
const url = `${SUPABASE_URL}/rest/v1/nodes?order=is_free.desc&t=${timestamp}`;
```

---

## ðŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### æ¯æ¬¡è¿è¡Œç»Ÿè®¡

| æŒ‡æ ‡ | ç›®æ ‡ | çŽ°çŠ¶ |
|------|------|------|
| èŠ‚ç‚¹æ€»æ•° | 200+ | âœ… æ”¯æŒ |
| æµ‹é€ŸæˆåŠŸçŽ‡ | >80% | âœ… 85/88 |
| æ‰§è¡Œæ—¶é—´ | <10 min | âœ… ~5 min |
| Supabase å†™å…¥ | <1 min | âœ… <1 min |
| å‰ç«¯åŠ è½½ | <3 sec | âœ… <2 sec |

### æˆæœ¬è®¡ç®—

| æœåŠ¡ | è´¹ç”¨ | å¤‡æ³¨ |
|------|------|------|
| GitHub Actions | $0 | å…è´¹é¢åº¦å……è¶³ |
| Aliyun FC | Â¥0 (~$0) | å…è´¹é¢åº¦: 100ä¸‡æ¬¡/æœˆ |
| Cloudflare Workers | $0 | å…è´¹: 10ä¸‡æ¬¡/å¤© |
| Supabase | $0 | å…è´¹é¢åº¦: 500MB |
| **æ€»è®¡** | **$0** | **å®Œå…¨å…è´¹** |

---

## ðŸ” å®‰å…¨æŽªæ–½

### å¯†é’¥ç®¡ç†

- âœ… æ‰€æœ‰å¯†é’¥å­˜å‚¨åœ¨ GitHub Secrets (ä¸åœ¨ä»£ç ä¸­)
- âœ… Supabase anon key ç”¨äºŽ REST API (åªè¯»æƒé™)
- âœ… Cloudflare Worker æ— è®¤è¯ (URL æœ¬èº«è¶³å¤Ÿå®‰å…¨)
- âœ… Aliyun FC URL åŒ…å« token (URL æ··æ·†)

### æ•°æ®ä¿æŠ¤

- âœ… public/nodes.json åœ¨ .gitignore ä¸­ (ä¸æäº¤èŠ‚ç‚¹å‡­è¯)
- âœ… åªæ˜¾ç¤ºé€šè¿‡æµ‹é€Ÿçš„èŠ‚ç‚¹ (è´¨é‡ä¿è¯)
- âœ… è‡ªåŠ¨åŽ»é‡ (é˜²æ­¢é‡å¤æ•°æ®)

### é™æµä¿æŠ¤

- âœ… Aliyun FC æ‰¹é‡å¤„ç† (é¿å…é¢‘çŽ‡é™åˆ¶)
- âœ… Cloudflare å¹¶å‘æµ‹è¯• (å……åˆ†åˆ©ç”¨)
- âœ… æ‰¹é—´éš” 0.5s (ç¤¼è²Œè°ƒç”¨)

---

## ðŸ“ æ•…éšœæŽ’æŸ¥

### å¸¸è§é—®é¢˜

| é—®é¢˜ | ç—‡çŠ¶ | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| èŠ‚ç‚¹æ•°ä¸º 0 | é¡µé¢æ˜¾ç¤º "No nodes" | æ£€æŸ¥ API å’Œ GitHub Secrets |
| å»¶è¿Ÿä¸º -1 | èŠ‚ç‚¹ä¸æ˜¾ç¤º | è¯¥èŠ‚ç‚¹åœ¨æµ‹é€Ÿåœ°åŒºä¸å¯è¾¾ |
| é¡µé¢æ˜¾ç¤ºæ—§æ•°æ® | åˆ·æ–°ä¸æ›´æ–° | æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–å¼ºåˆ¶åˆ·æ–° (Ctrl+Shift+R) |
| Supabase æŠ¥é”™ | ä¿å­˜å¤±è´¥ | æ£€æŸ¥è¡¨åã€å­—æ®µåã€unique çº¦æŸ |
| Worker è¶…æ—¶ | éƒ¨åˆ†èŠ‚ç‚¹æ— ç»“æžœ | å¢žåŠ è¶…æ—¶æˆ–å‡å°æ‰¹å¤§å° |

---

## ðŸŽ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] æ·»åŠ å¤§é™†å¤šåœ°åŒºæµ‹é€Ÿ (åŒ—äº¬/ä¸Šæµ·/å¹¿å·ž)
- [ ] å®žçŽ° WebSocket å®žæ—¶é€Ÿåº¦ç›‘æŽ§
- [ ] æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è¯„åˆ†æ ‡å‡†
- [ ] æ·»åŠ èŠ‚ç‚¹åŽ†å²æ•°æ®å’Œè¶‹åŠ¿å›¾
- [ ] é›†æˆæ›´å¤šå›½å¤–æµ‹é€Ÿç‚¹ (AWS/GCP/Azure)

---

**ç³»ç»Ÿè¿è¡Œè‰¯å¥½! æ‰€æœ‰æ¨¡å—å·²å°±ä½ã€‚** âœ…
