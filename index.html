<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHADOW NEXUS | èŠ‚ç‚¹æ ¸å¿ƒ</title>

    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2310b981'%3E%3Cpath d='M13 10V3L4 14h7v7l9-11h-7z'/%3E%3C/svg%3E"
        type="image/svg+xml">

    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.6.1/dist/easy.qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { 'viper-dark': '#050505', 'viper-card': '#111111' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out forwards' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(16, 185, 129, 0.06), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.06), transparent 25%);
            background-attachment: fixed;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .glass-card {
            background: rgba(20, 20, 22, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* å¼ºåˆ¶é™åˆ¶äºŒç»´ç æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ’‘ç ´å¼¹çª— */
        #qrcode {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #qrcode img,
        #qrcode canvas {
            display: block;
            max-width: 100% !important;
            height: auto !important;
            border: 4px solid white;
            border-radius: 4px;
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="text-gray-300 min-h-screen pb-20">

    <div class="fixed top-0 left-0 w-full z-50 border-b border-white/5 bg-[#050505]/80 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-lg blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200 animate-pulse">
                    </div>
                    <div
                        class="relative w-9 h-9 rounded-lg bg-[#0a0a0a] border border-white/10 flex items-center justify-center text-emerald-500 shadow-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                </div>
                <div>
                    <h1 class="font-black text-xl text-white tracking-widest uppercase italic">
                        SHADOW <span class="text-emerald-500 neon-text">NEXUS</span>
                    </h1>
                    <div
                        class="flex items-center gap-2 text-[9px] text-gray-500 font-mono leading-none mt-0.5 tracking-wider">
                        <span
                            class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-[pulse_1s_ease-in-out_infinite]"></span>
                        SYSTEM ONLINE
                        <span id="vip-badge"
                            class="hidden ml-2 px-1.5 py-0.5 bg-amber-500/20 text-amber-500 rounded text-[8px] border border-amber-500/30">VIP
                            ACTIVATED</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <!-- åœ°åŒºåˆ‡æ¢æŒ‰é’® -->
                <div class="flex items-center border border-white/10 rounded-lg overflow-hidden bg-white/5">
                    <button id="mainland-btn" onclick="switchRegion('mainland')"
                        class="px-3 py-1.5 text-xs font-mono font-bold transition-all bg-emerald-600/20 text-emerald-400 border-r border-white/10">
                        ğŸ‡¨ğŸ‡³ å¤§é™†
                    </button>
                    <button id="overseas-btn" onclick="switchRegion('overseas')"
                        class="px-3 py-1.5 text-xs font-mono font-bold transition-all hover:bg-white/10 text-gray-400 hover:text-white">
                        ğŸŒ æµ·å¤–
                    </button>
                </div>

                <button onclick="openCnModal()" id="cn-btn"
                    class="hidden px-3 py-1.5 bg-red-900/20 hover:bg-red-900/40 border border-red-500/30 rounded-lg text-xs font-mono font-bold text-red-400 hover:text-red-300 transition-colors flex items-center gap-1.5">
                    <span class="text-sm">ğŸ‡¨ğŸ‡³</span> CN LINE
                </button>

                <button onclick="toggleSpeedTestModal()" id="speedtest-btn"
                    class="px-3 py-1.5 bg-cyan-600/20 hover:bg-cyan-600/30 border border-cyan-500/30 rounded-lg text-xs font-mono font-bold text-cyan-400 hover:text-cyan-300 transition-colors flex items-center gap-1.5"
                    title="è§¦å‘åŒåŒºåŸŸæµ‹é€Ÿ">
                    <span class="text-sm">âš¡</span> TEST
                </button>

                <button onclick="toggleAuthModal()" id="auth-btn"
                    class="px-3 py-1.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-mono font-bold text-gray-400 hover:text-white transition-colors">
                    LOGIN
                </button>

                <button onclick="fetchData()"
                    class="p-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-gray-400 hover:text-emerald-400 transition-colors group"
                    title="åˆ·æ–°æ•°æ®">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:animate-spin" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
                <button onclick="copyAll()"
                    class="hidden md:block px-4 py-2 bg-emerald-600/10 hover:bg-emerald-600/20 border border-emerald-500/30 text-emerald-500 hover:text-emerald-400 rounded-lg text-sm font-bold tracking-wide transition-colors">
                    COPY ALL
                </button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 pt-24">
        <!-- åŒæ­¥çŠ¶æ€æ¨ªå¹… -->
        <div class="glass-card rounded-xl p-3 mb-6 border border-white/5 bg-gradient-to-r from-emerald-500/5 to-transparent">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 bg-emerald-500 rounded-full shadow-[0_0_8px_rgba(16,185,129,0.8)] animate-pulse"></div>
                    <div class="text-sm font-mono">
                        <span class="text-gray-400">æ•°æ®åŒæ­¥: </span>
                        <span id="sync-time-display" class="text-emerald-400 font-bold">æ­£åœ¨åŠ è½½...</span>
                        <span class="text-gray-600 text-xs ml-2">(<span id="nodes-count">0</span>ä¸ªæ´»è·ƒèŠ‚ç‚¹)</span>
                    </div>
                </div>
                <button onclick="triggerPollAndRefresh()" class="px-2 py-1 text-xs text-gray-400 hover:text-gray-300 transition-colors hover:bg-white/5 rounded" title="æ‰‹åŠ¨è§¦å‘åŒæ­¥å¹¶åˆ·æ–°æ˜¾ç¤º">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- è´¨é‡è¯´æ˜å¡ç‰‡ -->
        <div class="glass-card rounded-xl p-4 mb-6 border border-white/5">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-6 text-xs">
                    <span class="flex items-center gap-2">
                        <span class="w-3 h-3 bg-emerald-500 rounded-full shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                        <span class="text-gray-400">ä¼˜è´¨èŠ‚ç‚¹ <span class="text-gray-500">(å»¶è¿Ÿ&lt;300ms)</span></span>
                    </span>
                    <span class="flex items-center gap-2">
                        <span class="w-3 h-3 bg-amber-500 rounded-full"></span>
                        <span class="text-gray-400">ä¸­ç­‰èŠ‚ç‚¹ <span class="text-gray-500">(å»¶è¿Ÿ&lt;800ms)</span></span>
                    </span>
                    <span class="flex items-center gap-2">
                        <span class="w-3 h-3 bg-rose-500 rounded-full"></span>
                        <span class="text-gray-400">è¾ƒæ…¢èŠ‚ç‚¹ <span class="text-gray-500">(å»¶è¿Ÿ&gt;800ms)</span></span>
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-500">ç­›é€‰:</label>
                    <select id="quality-filter" onchange="filterNodes(this.value)" 
                        class="bg-[#0a0a0a] border border-white/10 rounded-lg px-3 py-1.5 text-xs text-gray-300 focus:border-emerald-500/50 outline-none">
                        <option value="all">å…¨éƒ¨èŠ‚ç‚¹</option>
                        <option value="high">ä»…ä¼˜è´¨</option>
                        <option value="medium">ä¸­ç­‰ä»¥ä¸Š</option>
                    </select>
                    <select id="sort-by" onchange="sortNodes(this.value)"
                        class="bg-[#0a0a0a] border border-white/10 rounded-lg px-3 py-1.5 text-xs text-gray-300 focus:border-emerald-500/50 outline-none">
                        <option value="quality">æŒ‰è´¨é‡æ’åº</option>
                        <option value="speed">æŒ‰é€Ÿåº¦æ’åº</option>
                        <option value="latency">æŒ‰å»¶è¿Ÿæ’åº</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="flex flex-wrap items-center justify-between mb-6 gap-3">
            <div
                class="glass-card px-5 py-2 rounded-full flex items-center gap-4 text-xs text-gray-400 shadow-lg overflow-x-auto">
                <span class="flex items-center gap-2 whitespace-nowrap">
                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                    NODES: <strong class="text-white font-mono text-sm" id="node-count">--</strong>
                </span>

                <span class="w-px h-3 bg-white/10"></span>

                <span class="whitespace-nowrap">STATUS: <strong class="text-emerald-400 font-mono"
                        id="user-status-text">GUEST</strong></span>

                <span class="w-px h-3 bg-white/10 hidden md:block"></span>

                <span class="hidden md:flex items-center gap-2 whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-cyan-400" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z"
                            clip-rule="evenodd" />
                    </svg>
                    NET I/O: <strong class="text-cyan-400 font-mono" id="monitor-io">0 KB/s</strong>
                </span>

                <span class="w-px h-3 bg-white/10 hidden md:block"></span>

                <span class="hidden md:flex items-center gap-2 whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-amber-400" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z"
                            clip-rule="evenodd" />
                    </svg>
                    HITS: <strong class="text-amber-400 font-mono" id="monitor-hits">--</strong>
                </span>
                
                <span class="w-px h-3 bg-white/10 hidden md:block"></span>
                
                <span class="hidden md:flex items-center gap-2 whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-emerald-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    VERIFIED: <strong class="text-emerald-400 font-mono" id="monitor-verified">--</strong>
                </span>

                <span class="w-px h-3 bg-white/10 hidden md:block"></span>

                <span class="hidden md:flex items-center gap-2 whitespace-nowrap">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    ONLINE: <strong class="text-emerald-400 font-mono" id="monitor-online">1</strong>
                </span>
            </div>
        </div>

        <div id="loading" class="flex flex-col items-center justify-center py-32 space-y-4">
            <div class="relative w-12 h-12">
                <div class="absolute inset-0 rounded-full border-2 border-white/5"></div>
                <div
                    class="absolute inset-0 rounded-full border-2 border-emerald-500 border-t-transparent animate-spin">
                </div>
            </div>
            <p class="text-gray-500 font-mono text-xs animate-pulse">SECURING CONNECTION...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5" id="grid"></div>

        <div id="empty-state" class="hidden text-center py-20 text-gray-500">NO SIGNAL DETECTED</div>
    </main>

    <textarea id="all-links" class="hidden"></textarea>

    <!-- åŒåŒºæµ‹é€Ÿæ¨¡æ€æ¡† -->
    <div id="speedtest-modal" class="fixed inset-0 z-[115] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="toggleSpeedTestModal()"></div>
        <div class="relative glass-card p-6 rounded-2xl w-full max-w-md border border-cyan-500/20 animate-fade-in z-20 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-2 tracking-wide flex items-center gap-2">
                <span class="text-xl">âš¡</span> åŒåŒºåŸŸæµ‹é€Ÿ
            </h3>
            <p class="text-xs text-gray-500 font-mono mb-4" id="speedtest-status">å‡†å¤‡å¼€å§‹...</p>
            
            <div id="speedtest-idle" class="space-y-3">
                <p class="text-xs text-gray-400 leading-relaxed">
                    æ­¤æ“ä½œå°†é€šè¿‡ Aliyun FCï¼ˆå¤§é™†ï¼‰å’Œ Cloudflare Workersï¼ˆæµ·å¤–ï¼‰å¯¹æ‰€æœ‰èŠ‚ç‚¹è¿›è¡ŒåŒåœ°åŒºæµ‹é€Ÿï¼Œé¢„è®¡è€—æ—¶ <strong>5-10 åˆ†é’Ÿ</strong>ã€‚
                </p>
                <div class="flex gap-2">
                    <button onclick="startSpeedTest()" 
                        class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white py-2.5 rounded-lg text-sm font-bold transition-colors">
                        å¼€å§‹æµ‹é€Ÿ
                    </button>
                    <button onclick="toggleSpeedTestModal()"
                        class="flex-1 bg-white/5 hover:bg-white/10 text-gray-300 border border-white/10 py-2.5 rounded-lg text-sm font-bold transition-colors">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>

            <div id="speedtest-running" class="hidden space-y-3">
                <div class="space-y-2">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-400">æµ‹é€Ÿè¿›åº¦</span>
                        <span class="text-cyan-400 font-mono font-bold" id="speedtest-progress">--</span>
                    </div>
                    <div class="h-2 w-full bg-black/40 rounded-full overflow-hidden">
                        <div id="speedtest-bar" class="h-full bg-cyan-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 font-mono space-y-1">
                    <div>ğŸ“¡ å¤§é™†æµ‹é€Ÿ: <span id="mainland-status" class="text-gray-400">ç­‰å¾…ä¸­...</span></div>
                    <div>ğŸŒ æµ·å¤–æµ‹é€Ÿ: <span id="overseas-status" class="text-gray-400">ç­‰å¾…ä¸­...</span></div>
                </div>
                <button onclick="toggleSpeedTestModal()" disabled
                    class="w-full bg-gray-700/20 text-gray-500 py-2.5 rounded-lg text-sm font-bold cursor-not-allowed">
                    æµ‹é€Ÿè¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…...
                </button>
            </div>

            <div id="speedtest-done" class="hidden space-y-3">
                <div class="bg-cyan-500/10 border border-cyan-500/30 p-3 rounded-lg">
                    <p class="text-sm text-cyan-400 font-bold">âœ… æµ‹é€Ÿå®Œæˆï¼</p>
                    <p class="text-xs text-gray-400 mt-1" id="speedtest-result-msg">æ­£åœ¨åˆ·æ–°é¡µé¢...</p>
                </div>
                <button onclick="toggleSpeedTestModal()"
                    class="w-full bg-cyan-600 hover:bg-cyan-500 text-white py-2.5 rounded-lg text-sm font-bold transition-colors">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="closeQR()"></div>
        <div
            class="relative bg-[#121212] border border-white/10 p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 w-[320px] max-w-full animate-fade-in z-10">
            <h3 class="text-white font-bold tracking-wider" id="qr-title">SCAN CODE</h3>
            <div id="qrcode"
                class="bg-white p-2 rounded-lg shadow-[0_0_20px_rgba(255,255,255,0.1)] min-h-[180px] flex items-center justify-center">
            </div>
            <p class="text-xs text-gray-600 text-center w-full truncate px-2 font-mono" id="qr-link-preview"></p>
            <button onclick="closeQR()"
                class="w-full py-2.5 bg-white/5 hover:bg-white/10 rounded-lg text-sm text-gray-300 font-medium transition-colors border border-white/5">CLOSE</button>
        </div>
    </div>

    <div id="auth-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="toggleAuthModal()"></div>
        <div
            class="relative glass-card p-6 rounded-2xl w-full max-w-sm border border-white/10 animate-fade-in z-20 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-1 tracking-wide">ACCESS CONTROL</h3>
            <p class="text-xs text-gray-500 font-mono mb-6" id="auth-subtitle">IDENTIFY YOURSELF</p>

            <div id="login-section" class="space-y-3">
                <input id="email" type="email" placeholder="Email Address"
                    class="w-full bg-[#0a0a0a] border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-emerald-500/50 outline-none transition-colors">
                <input id="password" type="password" placeholder="Password"
                    class="w-full bg-[#0a0a0a] border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:border-emerald-500/50 outline-none transition-colors">

                <div class="flex gap-3 pt-2">
                    <button onclick="handleLogin()"
                        class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 rounded-lg text-sm font-bold transition-colors shadow-[0_0_15px_rgba(16,185,129,0.2)]">
                        LOGIN
                    </button>
                    <button onclick="handleRegister()"
                        class="flex-1 bg-white/5 hover:bg-white/10 text-gray-300 border border-white/10 py-2.5 rounded-lg text-sm font-bold transition-colors">
                        REGISTER
                    </button>
                </div>
            </div>

            <div id="user-section" class="hidden space-y-4">
                <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                    <div class="text-xs text-gray-400 font-mono">ACCOUNT</div>
                    <div class="text-sm text-white font-bold truncate" id="current-email">user@example.com</div>
                    <div class="mt-2 text-xs text-gray-400 font-mono">VIP EXPIRATION</div>
                    <div class="text-emerald-400 font-mono font-bold" id="vip-date">--</div>
                </div>

                <div class="pt-2">
                    <label class="text-xs text-gray-500 font-mono block mb-1.5">REDEEM CODE (å¡å¯†)</label>
                    <div class="flex gap-2">
                        <input id="kami-code" type="text" placeholder="XXXX-XXXX-XXXX"
                            class="flex-1 bg-[#0a0a0a] border border-amber-500/30 rounded-lg px-3 py-2 text-sm text-amber-500 focus:border-amber-500 outline-none font-mono">
                        <button onclick="redeemKami()"
                            class="px-4 bg-amber-600/20 hover:bg-amber-600/30 border border-amber-500/50 text-amber-500 rounded-lg text-xs font-bold transition-colors">
                            ACTIVATE
                        </button>
                    </div>
                </div>

                <button onclick="handleLogout()"
                    class="w-full mt-2 py-2 text-xs text-red-400 hover:text-red-300 border border-red-500/20 hover:border-red-500/40 rounded-lg transition-colors">
                    LOGOUT
                </button>
            </div>

            <button onclick="toggleAuthModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <!-- ç²¾ç¡®æµ‹é€Ÿæ¨¡æ€æ¡† -->
    <div id="precision-test-modal" class="fixed inset-0 z-[108] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="closePrecisionTestModal()"></div>
        <div class="relative glass-card p-6 rounded-2xl w-full max-w-md border border-purple-500/20 animate-fade-in z-20 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white tracking-wide flex items-center gap-2">
                    <span class="text-2xl">âš¡</span> ç²¾ç¡®æµ‹é€Ÿ
                </h3>
                <button onclick="closePrecisionTestModal()" class="text-gray-500 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="precision-test-content" class="mb-4">
                <p class="text-sm text-gray-400 mb-3">é€‰æ‹©æµ‹è¯•æ–‡ä»¶å¤§å°ï¼ˆå°†æ¶ˆè€—å¯¹åº”æµé‡ï¼‰ï¼š</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectPrecisionTestSize(10)" class="py-2 px-3 rounded-lg text-sm bg-white/5 hover:bg-purple-500/20 text-gray-300 hover:text-purple-400 border border-white/5 hover:border-purple-500/30 transition-all">
                        10 MB
                    </button>
                    <button onclick="selectPrecisionTestSize(25)" class="py-2 px-3 rounded-lg text-sm bg-white/5 hover:bg-purple-500/20 text-gray-300 hover:text-purple-400 border border-white/5 hover:border-purple-500/30 transition-all">
                        25 MB
                    </button>
                    <button onclick="selectPrecisionTestSize(50)" class="py-2 px-3 rounded-lg text-sm bg-white/5 hover:bg-purple-500/20 text-gray-300 hover:text-purple-400 border border-white/5 hover:border-purple-500/30 transition-all">
                        50 MB
                    </button>
                    <button onclick="selectPrecisionTestSize(100)" class="py-2 px-3 rounded-lg text-sm bg-white/5 hover:bg-purple-500/20 text-gray-300 hover:text-purple-400 border border-white/5 hover:border-purple-500/30 transition-all">
                        100 MB
                    </button>
                </div>
            </div>

            <div id="precision-test-confirm" class="hidden">
                <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4 mb-4">
                    <p class="text-sm text-gray-300 mb-3">ç¡®è®¤æµ‹é€Ÿå‚æ•°ï¼š</p>
                    <div class="space-y-2">
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>æ–‡ä»¶å¤§å°:</span>
                            <span class="text-purple-300" id="confirm-test-size">50 MB</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>é¢„è®¡æµé‡æ¶ˆè€—:</span>
                            <span class="text-purple-300" id="confirm-traffic">50 MB</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>é¢„è®¡è€—æ—¶:</span>
                            <span class="text-purple-300">1-30 ç§’</span>
                        </div>
                    </div>
                    <p class="text-xs text-amber-400 mt-3">âš ï¸ ç²¾ç¡®æµ‹é€Ÿä¼šæ¶ˆè€—å¯¹åº”æµé‡ï¼Œè¯·ç¡®è®¤åå†å¼€å§‹</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="cancelPrecisionTest()" class="py-2 px-3 rounded-lg text-sm bg-white/5 hover:bg-red-500/20 text-gray-300 hover:text-red-400 border border-white/5 hover:border-red-500/30 transition-all">
                        å–æ¶ˆ
                    </button>
                    <button onclick="confirmPrecisionTest()" class="py-2 px-3 rounded-lg text-sm bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 hover:text-purple-400 border border-purple-500/30 hover:border-purple-500/50 transition-all font-bold">
                        ç¡®è®¤å¼€å§‹
                    </button>
                </div>
            </div>

            <div id="precision-test-running" class="hidden">
                <div class="space-y-3">
                    <p class="text-xs text-gray-400">æµ‹è¯•è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...</p>
                    <div class="w-full h-2 bg-black/40 rounded-full overflow-hidden">
                        <div id="precision-test-progress-bar" class="h-full bg-purple-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-500 text-center"><span id="precision-test-progress-text">0%</span></p>
                </div>
            </div>

            <div id="precision-test-result" class="hidden">
                <div class="space-y-3 bg-white/5 p-3 rounded-lg">
                    <p class="text-sm font-bold text-purple-400" id="precision-test-result-title">æµ‹è¯•å®Œæˆ</p>
                    <div class="space-y-2">
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-500">ä¸‹è½½é€Ÿåº¦</span>
                            <span class="text-white font-mono" id="precision-test-speed">-- MB/s</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-500">ç”¨æ—¶</span>
                            <span class="text-white font-mono" id="precision-test-time">-- s</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-gray-500">æµé‡æ¶ˆè€—</span>
                            <span class="text-white font-mono" id="precision-test-traffic">-- MB</span>
                        </div>
                    </div>
                    <button onclick="closePrecisionTestModal()" class="w-full mt-3 py-2 px-3 rounded-lg text-sm bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 border border-purple-500/30 transition-all">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="cn-modal" class="fixed inset-0 z-[105] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="closeCnModal()"></div>
        <div
            class="relative glass-card p-6 rounded-2xl w-full max-w-4xl max-h-[85vh] flex flex-col border border-red-500/20 animate-fade-in z-20 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white tracking-wide flex items-center gap-2">
                    <span class="text-2xl">ğŸ‡¨ğŸ‡³</span> CN DIRECT LINES
                </h3>
                <button onclick="closeCnModal()" class="text-gray-500 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="overflow-y-auto pr-2 custom-scrollbar flex-1">
                <div id="cn-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-white/5 text-center">
                <p class="text-xs text-gray-500 font-mono">FOR DOMESTIC SERVICES ONLY</p>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[999] translate-y-20 opacity-0 transition-all duration-300 pointer-events-none">
        <div
            class="glass-card px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-emerald-500/30 bg-[#050505]/95 backdrop-blur-xl">
            <div
                class="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-black text-xs font-bold shadow-[0_0_10px_rgba(16,185,129,0.5)]">
                âœ“</div>
            <span class="text-sm font-bold text-white tracking-wide" id="toast-msg">COPIED</span>
        </div>
    </div>

    <div id="identity-modal"
        class="fixed inset-0 bg-black/95 z-[1000] hidden items-center justify-center backdrop-blur-sm">
        <div
            class="bg-gray-900 border-2 border-cyan-500 p-6 rounded-xl max-w-sm w-[90%] shadow-[0_0_50px_rgba(6,182,212,0.4)] relative overflow-hidden">

            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-cyan-500/20 rounded-full blur-xl"></div>

            <h3 class="text-2xl text-cyan-400 font-bold mb-2 flex items-center gap-2">
                <span>ğŸ†”</span> èº«ä»½å·²ç”Ÿæˆ
            </h3>
            <p class="text-gray-400 text-xs mb-4 leading-relaxed">
                ç³»ç»Ÿå·²ä¸ºæ‚¨åˆ›å»ºåŒ¿åé€šè¡Œè¯ã€‚<br>
                <span class="text-red-400 font-bold">âš ï¸ è¯·åŠ¡å¿…ä¿å­˜ä¸‹æ–¹ä¿¡æ¯ï¼Œè¿™æ˜¯æ‚¨æ‰¾å›è´¦å·çš„å”¯ä¸€å‡­è¯ï¼</span>
            </p>

            <div class="bg-black/60 border border-gray-700 rounded-lg p-4 mb-5 font-mono text-sm relative group">
                <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                    <span class="text-gray-500">è´¦å· (ID)</span>
                    <span id="new-username" class="text-green-400 font-bold select-all">Loading...</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">å¯†ç  (Key)</span>
                    <span id="new-password" class="text-cyan-400 font-bold select-all">Loading...</span>
                </div>
                <div id="copy-tip"
                    class="absolute inset-0 bg-cyan-900/90 flex items-center justify-center text-cyan-200 font-bold opacity-0 transition-opacity pointer-events-none">
                    å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!
                </div>
            </div>

            <div class="space-y-3">
                <button onclick="copyIdentity()"
                    class="w-full border border-cyan-500/50 hover:bg-cyan-500/10 text-cyan-400 py-2.5 rounded transition-colors flex items-center justify-center gap-2">
                    <span>ğŸ“‹</span> ä¸€é”®å¤åˆ¶ (Copy)
                </button>
                <button onclick="downloadIdentity()"
                    class="w-full border border-green-500/50 hover:bg-green-500/10 text-green-400 py-2.5 rounded transition-colors flex items-center justify-center gap-2">
                    <span>ğŸ’¾</span> ä¸‹è½½å‡­è¯ (.txt)
                </button>
                <button onclick="closeIdentityModal()" id="btn-enter"
                    class="w-full bg-gray-700 text-gray-500 font-bold py-3 rounded cursor-not-allowed mt-2" disabled>
                    è¯·å…ˆä¿å­˜è´¦å·
                </button>
            </div>
        </div>
    </div>


    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const SUPABASE_URL = 'https://hnlkwtkxbqiakeyienok.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhubGt3dGt4YnFpYWtleWllbm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MDQwNTksImV4cCI6MjA4MjQ4MDA1OX0.Xg9vQdUfBdUW-IJaomEIRGsX6tB_k2grhrF4dm_aNME';

        // ğŸ”¥ æ”¹è¿›ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ° SpiderFlow åç«¯ï¼Œç„¶åæ‰æ˜¯ Cloudflare Tunnel
        // æœ¬åœ°å¼€å‘ç¯å¢ƒï¼šlocalhost:8002 (viper-node-store FastAPI åç«¯å¿…é¡»å¯åŠ¨)
        // äº‘ç«¯éƒ¨ç½²ï¼šhttps://api.996828.xyz (éœ€è¦åœ¨ Vercel ç¯å¢ƒå˜é‡æˆ– vercel.json é…ç½®)
        const VIPER_API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:8002'
            : 'https://api.996828.xyz';

        let supabaseClient;
        if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            alert('System Error: Supabase SDK failed to load.');
        }

        const countryMap = { 'CN': 'å›å›½', 'HK': 'é¦™æ¸¯', 'TW': 'å°æ¹¾', 'JP': 'æ—¥æœ¬', 'KR': 'éŸ©å›½', 'SG': 'æ–°åŠ å¡', 'US': 'ç¾å›½', 'GB': 'è‹±å›½', 'DE': 'å¾·å›½', 'FR': 'æ³•å›½', 'NL': 'è·å…°', 'RU': 'ä¿„ç½—æ–¯', 'CA': 'åŠ æ‹¿å¤§', 'AU': 'æ¾³å¤§åˆ©äºš', 'IN': 'å°åº¦', 'BR': 'å·´è¥¿', 'UNK': 'æœªçŸ¥' };
        let globalCnNodes = [];
        let globalNormalNodes = []; // ç¼“å­˜æ™®é€šèŠ‚ç‚¹ç”¨äºç­›é€‰
        
        // ================= åœ°åŒºåˆ‡æ¢çŠ¶æ€ =================
        let currentRegion = 'mainland'; // é»˜è®¤å¤§é™†
        let allRegionData = {
            mainland: [],     // å¤§é™†èŠ‚ç‚¹ï¼ˆæœ‰mainland_scoreæˆ–åŸºç¡€å¤§é™†èŠ‚ç‚¹ï¼‰
            overseas: []      // æµ·å¤–èŠ‚ç‚¹ï¼ˆæœ‰overseas_scoreæˆ–åŸºç¡€æµ·å¤–èŠ‚ç‚¹ï¼‰
        };

        // ================= åœ°åŒºåˆ‡æ¢å‡½æ•° =================
        function switchRegion(region) {
            currentRegion = region;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const mainlandBtn = document.getElementById('mainland-btn');
            const overseasBtn = document.getElementById('overseas-btn');
            
            if (region === 'mainland') {
                mainlandBtn.className = 'px-3 py-1.5 text-xs font-mono font-bold transition-all bg-emerald-600/20 text-emerald-400 border-r border-white/10';
                overseasBtn.className = 'px-3 py-1.5 text-xs font-mono font-bold transition-all hover:bg-white/10 text-gray-400 hover:text-white';
            } else {
                mainlandBtn.className = 'px-3 py-1.5 text-xs font-mono font-bold transition-all hover:bg-white/10 text-gray-400 hover:text-white border-r border-white/10';
                overseasBtn.className = 'px-3 py-1.5 text-xs font-mono font-bold transition-all bg-emerald-600/20 text-emerald-400';
            }
            
            // é‡æ–°æ¸²æŸ“æ•°æ® - ä½¿ç”¨å½“å‰åˆ†ç±»çš„å­˜å‚¨æ•°æ®
            const grid = document.getElementById('grid');
            const empty = document.getElementById('empty-state');
            
            const nodesToDisplay = allRegionData[region] || [];
            
            if (nodesToDisplay.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                empty.innerHTML = `
                    <div class="text-center">
                        <p class="text-gray-400 text-sm">æš‚æ— ${region === 'mainland' ? 'å¤§é™†' : 'æµ·å¤–'}èŠ‚ç‚¹æ•°æ®</p>
                        <p class="text-gray-500 text-xs mt-2">è¯·ç¨å€™ï¼Œæˆ–æ£€æŸ¥æ•°æ®æº</p>
                    </div>
                `;
            } else {
                empty.classList.add('hidden');
                // ä¿å­˜åˆ°å…¨å±€èŠ‚ç‚¹åˆ—è¡¨ï¼Œä»¥ä¾¿ç­›é€‰å’Œæ’åºä½¿ç”¨
                globalNormalNodes = nodesToDisplay;
                updateStats(nodesToDisplay);
                renderNodes(nodesToDisplay);
            }
        }

        // å¯åŠ¨ç¨‹åº
        (async () => {
            await fetchData();
            // fetchDataå®Œæˆåç«‹å³è·å–åŒæ­¥ä¿¡æ¯
            fetchSyncInfo();
        })();
        
        initTelemetry(); // å¯åŠ¨ç›‘æ§é¥æµ‹

        // ================= æ ¸å¿ƒåŠŸèƒ½å‡½æ•° =================

        // 1. [å…³é”®ä¿®å¤] è·å– VIP çŠ¶æ€
        async function getVipStatus() {
            if (!supabaseClient) return { user: null, isVip: false };
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return { user: null, isVip: false };

                // ğŸ”¥ [ä¿®å¤ç‚¹] å°† .single() æ”¹ä¸º .maybeSingle()
                // è§£é‡Šï¼šæ–°ç”¨æˆ·(QuickStart)åœ¨profilesè¡¨é‡Œå¯èƒ½è¿˜æ²¡æ•°æ®ã€‚
                // .single() æ²¡æ‰¾åˆ°ä¼šæŠ¥ 406 é”™è¯¯ï¼Œ.maybeSingle() æ²¡æ‰¾åˆ°ä¼šè¿”å› null (è§†ä¸ºæ™®é€šç”¨æˆ·)ï¼Œä¸ä¼šæŠ¥é”™ã€‚
                const { data } = await supabaseClient
                    .from('profiles')
                    .select('vip_until')
                    .eq('id', user.id)
                    .maybeSingle();

                const isVip = data?.vip_until && new Date(data.vip_until) > new Date();
                return { user, isVip, vipDate: data?.vip_until };
            } catch (e) {
                console.warn("VIP check failed:", e); // ä»…è­¦å‘Šï¼Œä¸é˜»æ–­æµç¨‹
                return { user: null, isVip: false };
            }
        }

        // 2. è·å–èŠ‚ç‚¹æ•°æ® (æ”¯æŒåœ°åŒºåˆ‡æ¢)
        async function fetchData() {
            const loading = document.getElementById('loading');
            const grid = document.getElementById('grid');
            const empty = document.getElementById('empty-state');
            const cnBtn = document.getElementById('cn-btn');

            loading.classList.remove('hidden');
            grid.innerHTML = '';
            empty.classList.add('hidden');
            cnBtn.classList.add('hidden');

            try {
                // A. èº«ä»½æ£€æŸ¥
                const { user, isVip, vipDate } = await getVipStatus();
                updateAuthUI(user, isVip, vipDate);

                // B. ä»åç«¯ SpiderFlow ç›´æ¥è·å–èŠ‚ç‚¹æ•°æ®
                const response = await fetch(`${VIPER_API_BASE}/api/nodes?limit=500`, {
                    method: 'GET',
                    cache: 'no-store'
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Proxy error:', response.status, errorData);
                    throw new Error(`API error: ${response.status}`);
                }
                
                const rawNodes = await response.json();
                if (!Array.isArray(rawNodes) || rawNodes.length === 0) {
                    // èŠ‚ç‚¹æ­£åœ¨æ£€æµ‹ä¸­ï¼Œæ˜¾ç¤ºå‹å¥½æ¶ˆæ¯è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
                    empty.classList.remove('hidden');
                    empty.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center mb-4 animate-pulse">
                                <span class="text-4xl">â³</span>
                            </div>
                            <p class="text-gray-400 text-lg font-semibold mb-2">èŠ‚ç‚¹æ£€æµ‹ä¸­...</p>
                            <p class="text-gray-500 text-sm max-w-md text-center">
                                åç«¯æ­£åœ¨æŠ“å–å’ŒéªŒè¯èŠ‚ç‚¹ï¼Œè¿™é€šå¸¸éœ€è¦ 2-5 åˆ†é’Ÿ<br/>
                                è¯·ç¨å€™å¹¶åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°èŠ‚ç‚¹
                            </p>
                            <button onclick="fetchNodes()" class="mt-6 px-6 py-2 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded-lg transition-colors">
                                ğŸ”„ åˆ·æ–°
                            </button>
                        </div>
                    `;
                    loading.classList.add('hidden');
                    return;
                }

                // è§£æèŠ‚ç‚¹å†…å®¹
                const allNodes = rawNodes.map(item => {
                    try {
                        const nodeContent = typeof item.content === 'string' ? JSON.parse(item.content) : item.content;
                        return {
                            // ä¿ç•™åŸå§‹ item çš„æ‰€æœ‰å­—æ®µï¼Œç„¶ååˆå¹¶ nodeContent
                            ...item,
                            // ç¡®ä¿ nodeContent ä¸­çš„å­—æ®µè¢«åˆå¹¶ï¼Œä½† item çš„ä¼˜å…ˆçº§æ›´é«˜ï¼ˆç‰¹åˆ«æ˜¯ linkï¼‰
                            ...nodeContent,
                            // å†æ¬¡æ˜¾å¼ä¿è¯è¿™äº›å…³é”®å­—æ®µä½¿ç”¨ item ä¸­çš„å€¼
                            link: item.link || nodeContent.subscribe_link,
                            // æ·»åŠ æµ‹è¯•æ•°æ®å­—æ®µï¼ˆä» Supabase ç›´æ¥å–ï¼Œæˆ–ä» SpiderFlow åç«¯è·å–ï¼‰
                            speed: item.speed || 0,
                            latency: item.latency || 0,
                            is_free: item.is_free || false,
                            mainland_score: item.mainland_score || 0,
                            mainland_latency: item.mainland_latency || 0,
                            overseas_score: item.overseas_score || 0,
                            overseas_latency: item.overseas_latency || 0
                        };
                    } catch (e) {
                        console.error('Failed to parse node:', e);
                        return null;
                    }
                }).filter(n => n !== null);

                // C. ç²¾ç¡®åˆ†ç±»èŠ‚ç‚¹ï¼ˆä¼˜å…ˆç”¨åˆ†æ•°ï¼Œæ²¡æœ‰åˆ†æ•°å°±ç”¨ alive çŠ¶æ€ï¼‰
                
                // æå– CN å›½å®¶çš„èŠ‚ç‚¹ï¼ˆcountry === 'CN'ï¼‰
                const cnAllNodes = allNodes.filter(n => n.country === 'CN');
                
                // é CN çš„èŠ‚ç‚¹
                const nonCnNodes = allNodes.filter(n => n.country !== 'CN');
                
                // å¤§é™†èŠ‚ç‚¹ = æœ‰mainland_scoreçš„èŠ‚ç‚¹ æˆ– æ´»ç€çš„èŠ‚ç‚¹ï¼ˆç›´æ¥ç”¨åŸºç¡€æ£€æµ‹ç»“æœï¼‰
                let mainlandNodes = nonCnNodes.filter(n => {
                    // ä¼˜å…ˆç”¨åˆ†æ•°æ•°æ®ï¼ˆAliyun FC æµ‹é€Ÿç»“æœï¼‰
                    if (typeof n.mainland_score === 'number' && n.mainland_score > 0) {
                        return true;
                    }
                    // æ²¡æœ‰åˆ†æ•°ï¼Œå°±ç”¨åŸºç¡€æ´»èŠ‚ç‚¹
                    return n.alive === true || n.available === true;
                });

                // æµ·å¤–èŠ‚ç‚¹ = æœ‰overseas_scoreçš„èŠ‚ç‚¹ æˆ– æ´»ç€çš„èŠ‚ç‚¹
                let overseasNodes = nonCnNodes.filter(n => {
                    // ä¼˜å…ˆç”¨åˆ†æ•°æ•°æ®ï¼ˆCloudflare æµ‹é€Ÿç»“æœï¼‰
                    if (typeof n.overseas_score === 'number' && n.overseas_score > 0) {
                        return true;
                    }
                    // æ²¡æœ‰åˆ†æ•°ï¼Œå°±ç”¨åŸºç¡€æ´»èŠ‚ç‚¹
                    return n.alive === true || n.available === true;
                });

                // å¦‚æœå¤§é™†å’Œæµ·å¤–éƒ½æ²¡æœ‰èŠ‚ç‚¹ï¼Œå°±éƒ½ç”¨æ‰€æœ‰æ´»èŠ‚ç‚¹ï¼ˆå…œåº•ï¼‰
                if (mainlandNodes.length === 0 && overseasNodes.length === 0) {
                    const aliveNodes = nonCnNodes.filter(n => n.alive === true || n.available === true);
                    if (aliveNodes.length > 0) {
                        mainlandNodes = aliveNodes.slice(0, Math.ceil(aliveNodes.length / 2));
                        overseasNodes = aliveNodes.slice(Math.ceil(aliveNodes.length / 2));
                    }
                }
                
                // D. æƒé™è¿‡æ»¤
                let filteredMainland = mainlandNodes;
                let filteredOverseas = overseasNodes;
                
                if (!isVip) {
                    filteredMainland = filteredMainland.slice(0, 20);
                    filteredOverseas = filteredOverseas.slice(0, 20);
                }

                // E. ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼ˆç¡®ä¿å¤§é™†å’Œæµ·å¤–åˆ†å¼€ï¼‰
                allRegionData.mainland = filteredMainland;
                allRegionData.overseas = filteredOverseas;
                
                // ä¿å­˜æ‰€æœ‰èŠ‚ç‚¹æ•°æ®åˆ° window.nodesDataï¼Œç”¨äºç²¾å‡†æµ‹é€Ÿæ—¶æŸ¥æ‰¾èŠ‚ç‚¹å¯¹è±¡
                window.nodesData = allNodes;
                
                // F. CN å›å›½èŠ‚ç‚¹ï¼ˆå•ç‹¬æå–ï¼Œåªåœ¨å¼¹çª—æ˜¾ç¤ºï¼‰
                globalCnNodes = cnAllNodes.filter(n => n.alive === true || n.available === true).slice(0, isVip ? 50 : 10);
                
                // G. é»˜è®¤æ˜¾ç¤ºï¼šä¸¥æ ¼æŒ‰åˆ†æ•°æ˜¾ç¤ºï¼›è‹¥æ²¡æœ‰å½“å‰åŒºåŸŸåˆ†æ•°ä½†æœ‰éƒ¨åˆ†å·²æµ‹èŠ‚ç‚¹ï¼Œåˆ™æ˜¾ç¤ºå¿«ç…§
                const scoredNodes = allNodes.filter(n => (typeof n.mainland_score === 'number' && n.mainland_score > 0) || (typeof n.overseas_score === 'number' && n.overseas_score > 0));

// G. æ˜¾ç¤ºé€»è¾‘ï¼šæœ‰åˆ†æ•°æˆ–æœ‰åŸºç¡€æ•°æ®å°±æ˜¾ç¤º
                if (filteredMainland.length > 0 || filteredOverseas.length > 0) {
                    // æœ‰èŠ‚ç‚¹æ•°æ®ï¼ˆåˆ†æ•°æˆ–åŸºç¡€ï¼‰ï¼Œæ˜¾ç¤ºå¯¹åº”åˆ†ç±»
                    empty.classList.add('hidden');
                    updateStats(allRegionData[currentRegion]);
                    renderNodes(allRegionData[currentRegion]);
                } else {
                    // æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹æ•°æ®
                    document.getElementById('empty-state').classList.remove('hidden');
                    document.getElementById('empty-state').innerHTML = `
                        <div class="text-center">
                            <p class="text-gray-400 text-sm">â³ èŠ‚ç‚¹æ£€æµ‹ä¸­...</p>
                            <p class="text-gray-500 text-xs mt-2">åç«¯æ­£åœ¨è·å–å’ŒéªŒè¯èŠ‚ç‚¹ï¼Œè¯·ç¨å€™</p>
                        </div>
                    `;
                }

                // H. æ˜¾ç¤ºæˆ–éšè— CN å¼¹çª—æŒ‰é’®ï¼ˆæœ‰ CN èŠ‚ç‚¹å°±æ˜¾ç¤ºï¼‰
                if (globalCnNodes.length > 0) {
                    cnBtn.classList.remove('hidden');
                } else {
                    cnBtn.classList.add('hidden');
                }
                loading.classList.add('hidden');
                
                // é‡ç½®ç­›é€‰å™¨
                document.getElementById('quality-filter').value = 'all';
                document.getElementById('sort-by').value = 'quality';

            } catch (err) {
                console.error(err);
                empty.classList.remove('hidden');
                empty.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full">
                        <div class="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center mb-4">
                            <span class="text-4xl">âŒ</span>
                        </div>
                        <p class="text-red-400 text-lg font-semibold mb-2">è¿æ¥å¤±è´¥</p>
                        <p class="text-gray-500 text-sm max-w-md text-center mb-4">
                            ${err.message}
                        </p>
                        <button onclick="fetchNodes()" class="px-6 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-colors">
                            ğŸ”„ é‡è¯•
                        </button>
                    </div>
                `;
                loading.classList.add('hidden');
            }
        }

        // ================= ğŸ“¡ å®æ—¶ç›‘æ§é¥æµ‹é€»è¾‘ =================
        let lastBytesTotal = 0;
        let lastCheckTime = 0;

        async function initTelemetry() {
            // æ¯ 3 ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
            setInterval(updateMonitorStats, 3000);
            updateMonitorStats(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        }

        async function updateMonitorStats() {
            try {
                // ğŸ”¥ [ä¿®å¤ç‚¹ 1] è·¯ç”±æ”¹å› /api/system/stats (åŒ¹é…ç°åœ¨çš„åç«¯)
                const sysRes = await fetch(`${VIPER_API_BASE}/api/system/stats`);
                if (sysRes.ok) {
                    const sysData = await sysRes.json();
                    if (sysData.network) {
                        const currentTotal = (sysData.network.bytes_sent || 0) + (sysData.network.bytes_recv || 0);
                        const now = Date.now();

                        // è®¡ç®—é€Ÿåº¦ (Throughput)
                        if (lastBytesTotal > 0 && lastCheckTime > 0) {
                            const deltaBytes = currentTotal - lastBytesTotal;
                            const deltaTime = (now - lastCheckTime) / 1000;
                            if (deltaTime > 0) {
                                const speedBps = deltaBytes / deltaTime;
                                document.getElementById('monitor-io').innerText = formatSpeed(speedBps);
                            }
                        }

                        lastBytesTotal = currentTotal;
                        lastCheckTime = now;
                    }
                }

                // ğŸ”¥ [ä¿®å¤ç‚¹ 2] è·¯ç”±æ”¹å› /api/visitors/stats (å¤æ•° visitors)
                const visitRes = await fetch(`${VIPER_API_BASE}/api/visitors/stats`);
                if (visitRes.ok) {
                    const visitData = await visitRes.json();
                    if (visitData.total_visitors !== undefined) {
                        document.getElementById('monitor-hits').innerText = visitData.total_visitors.toLocaleString();
                    }
                }
                // ğŸ”¥ æ›´æ–°å½“å‰åœ¨çº¿äººæ•°
                if (visitData.online_count !== undefined) {
                    document.getElementById('monitor-online').innerText = visitData.online_count;
                }

            } catch (e) {
                // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡
                // console.warn("[Telemetry] Fetch failed:", e);
            }
        }

        function formatSpeed(bytesPerSec) {
            if (bytesPerSec < 1024) return bytesPerSec.toFixed(0) + " B/s";
            if (bytesPerSec < 1024 * 1024) return (bytesPerSec / 1024).toFixed(1) + " KB/s";
            return (bytesPerSec / (1024 * 1024)).toFixed(2) + " MB/s";
        }

        // ================= UI æ›´æ–°é€»è¾‘ =================
        function updateAuthUI(user, isVip, vipDate) {
            const loginSection = document.getElementById('login-section');
            const userSection = document.getElementById('user-section');
            const authBtn = document.getElementById('auth-btn');
            const statusText = document.getElementById('user-status-text');
            const vipBadge = document.getElementById('vip-badge');
            const subtitle = document.getElementById('auth-subtitle');

            if (user) {
                loginSection.classList.add('hidden');
                userSection.classList.remove('hidden');
                document.getElementById('current-email').innerText = user.email;
                if (isVip) {
                    statusText.innerText = "VIP MEMBER";
                    statusText.className = "text-amber-400 font-mono";
                    vipBadge.classList.remove('hidden');
                    document.getElementById('vip-date').innerText = new Date(vipDate).toLocaleDateString();
                    authBtn.innerText = "VIP";
                    authBtn.className = "px-3 py-1.5 bg-amber-500/20 border border-amber-500/50 rounded-lg text-xs font-mono font-bold text-amber-500 transition-colors";
                } else {
                    statusText.innerText = "FREE USER";
                    statusText.className = "text-gray-400 font-mono";
                    vipBadge.classList.add('hidden');
                    document.getElementById('vip-date').innerText = "NOT ACTIVE";
                    authBtn.innerText = "ACCOUNT";
                }
                subtitle.innerText = "WELCOME BACK, OPERATOR";
            } else {
                loginSection.classList.remove('hidden');
                userSection.classList.add('hidden');
                statusText.innerText = "GUEST (PREVIEW)";
                vipBadge.classList.add('hidden');
                authBtn.innerText = "LOGIN";
                subtitle.innerText = "IDENTIFY YOURSELF";
            }
        }

        // æ¸²æŸ“èŠ‚ç‚¹å¡ç‰‡
        // ================= èŠ‚ç‚¹æ¸²æŸ“ä¸æ˜¾ç¤º =================
        function renderNodes(data) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            if (data.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            data.forEach((node, index) => {
                grid.appendChild(createNodeCard(node, index));
            });
        }
        function renderCnNodes() {
            const grid = document.getElementById('cn-grid');
            grid.innerHTML = '';
            globalCnNodes.forEach((node, index) => {
                grid.appendChild(createNodeCard(node, index));
            });
        }
      function createNodeCard(node, index) {
            const delay = Math.min(index * 30, 800);
            const cnName = countryMap[node.country] || node.country || 'å¢ƒå¤–';

            // 1. è·å–åŸºç¡€æ•°æ® (è¿™é‡Œåªå®šä¹‰ä¸€æ¬¡ï¼Œé˜²æ­¢æŠ¥é”™)
            const latency = node.latency || node.latency_ms || 0;
            const successRate = node.success_rate || 100;

            // 2. ä¿®æ­£é€Ÿåº¦æ˜¾ç¤º (å¼ºåˆ¶é™åˆ¶åœ¨ 100MB/s ä»¥å†…ï¼Œä¿ç•™1ä½å°æ•°)
            const rawSpeed = node.speed || 0;
            const displaySpeed = Math.min(rawSpeed, 100).toFixed(1);

            // 3. è®¡ç®—è´¨é‡è¯„åˆ† (å¦‚æœæ²¡æœ‰åç«¯è¯„åˆ†ï¼Œè¿›è¡Œå‰ç«¯ä¼°ç®—)
            let qualityScore = node.quality_score;
            if (qualityScore === undefined || qualityScore === null) {
                if (rawSpeed >= 10) qualityScore = 80;
                else if (rawSpeed >= 5) qualityScore = 60;
                else if (rawSpeed >= 2) qualityScore = 40;
                else qualityScore = 20;
            }

            // 4. æ ·å¼çŠ¶æ€åˆ¤å®š
            let speedColor = 'text-gray-500', barColor = 'bg-gray-700', glowClass = '', statusBadge = '';

            if (qualityScore >= 70) {
                speedColor = 'text-emerald-400';
                barColor = 'bg-emerald-500';
                glowClass = 'shadow-[0_0_8px_rgba(16,185,129,0.4)]';
                statusBadge = '<span class="absolute top-2 right-2 w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>';
            } else if (qualityScore >= 40) {
                speedColor = 'text-amber-400';
                barColor = 'bg-amber-500';
                statusBadge = '<span class="absolute top-2 right-2 w-2 h-2 bg-amber-500 rounded-full"></span>';
            } else if (qualityScore > 0) {
                speedColor = 'text-rose-400';
                barColor = 'bg-rose-500';
                statusBadge = '<span class="absolute top-2 right-2 w-2 h-2 bg-rose-500 rounded-full"></span>';
            }

            // 5. å»¶è¿Ÿæ˜¾ç¤ºæ–‡æœ¬
            const latencyText = latency > 0 ? `${Math.round(latency)}ms` : '--';
            const latencyColor = latency > 0 ? (latency < 300 ? 'text-emerald-400' : latency < 800 ? 'text-amber-400' : 'text-rose-400') : 'text-gray-500';

            const nodeId = `node-${node.host}-${node.port}`.replace(/\./g, '-');

            const card = document.createElement('div');
            card.className = "glass-card rounded-xl p-4 relative group hover:border-emerald-500/30 transition-all duration-300 hover:-translate-y-1 flex flex-col justify-between h-[180px] animate-fade-in hover:shadow-lg hover:shadow-emerald-900/10";
            card.style.animationDelay = `${delay}ms`;
            card.id = nodeId;

            // 6. ç»„è£… HTML
            card.innerHTML = `
                ${statusBadge}
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2.5">
                        <span class="text-2xl filter drop-shadow-md">${getFlagEmoji(node.country)}</span>
                        <div>
                            <h3 class="font-bold text-gray-200 text-sm w-28 truncate group-hover:text-emerald-400 transition-colors" title="${node.name}">${cnName}</h3>
                            <div class="flex items-center gap-1.5 mt-0.5">
                                <span class="text-[10px] font-mono bg-white/10 px-1.5 py-0.5 rounded text-gray-400 uppercase tracking-wider">${node.protocol}</span>
                                ${successRate < 100 ? `<span class="text-[9px] font-mono ${successRate >= 80 ? 'text-emerald-500' : 'text-amber-500'}">${successRate}%</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-mono text-xs font-bold ${speedColor}">${displaySpeed} <span class="text-[9px] opacity-70">MB/s</span></div>
                        <div class="font-mono text-[10px] ${latencyColor} flex items-center justify-end gap-1" id="${nodeId}-latency" title="Server-side Latency (US)">
                            <span class="opacity-50 text-[8px]">âš¡</span>
                            ${latencyText}
                        </div>
                    </div>
                </div>
                <div class="text-[10px] text-gray-500 font-mono truncate mb-2 flex items-center gap-1.5 px-1 border-l-2 border-white/5 pl-2 ml-1">${node.host}:${node.port}</div>
                <div class="h-1.5 w-full bg-black/40 rounded-full overflow-hidden mb-auto">
                    <div class="h-full ${barColor} ${glowClass} transition-all duration-700" style="width: ${Math.min(qualityScore, 100)}%"></div>
                </div>
                <div class="grid grid-cols-4 gap-2 mt-3">
                    <button onclick="copyLink('${node.link}')" class="col-span-2 py-1.5 rounded-lg text-xs font-bold bg-white/5 hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-400 border border-white/5 hover:border-emerald-500/30 transition-all active:scale-[0.98] tracking-wide">COPY</button>
                    <button onclick="openPrecisionTestModal('${node.link}', '${cnName}')" class="col-span-1 py-1.5 rounded-lg text-xs flex items-center justify-center bg-white/5 hover:bg-purple-500/20 text-gray-400 hover:text-purple-400 border border-white/5 hover:border-purple-500/30 transition-all active:scale-[0.98]" title="ç²¾ç¡®æµ‹é€Ÿ">âš¡</button>
                    <button onclick="showQR('${node.link}', '${cnName} ${node.protocol}')" class="col-span-1 py-1.5 rounded-lg text-xs flex items-center justify-center bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white border border-white/5 transition-all active:scale-[0.98]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                    </button>
                </div>
            `;
            return card;
        }
        
        // ================= ç­›é€‰ä¸æ’åºåŠŸèƒ½ =================
        
        // ç»Ÿä¸€çš„è´¨é‡è¯„åˆ†è®¡ç®—å‡½æ•°
        function getNodeQualityScore(n) {
            if (n.quality_score !== undefined && n.quality_score !== null) return n.quality_score;
            const speed = n.speed || 0;
            if (speed >= 10) return 80;
            if (speed >= 5) return 60;
            if (speed >= 2) return 40;
            return 20;
        }
        
        function filterNodes(quality) {
            let filtered = [...globalNormalNodes];
            
            if (quality === 'high') {
                filtered = filtered.filter(n => getNodeQualityScore(n) >= 70);
            } else if (quality === 'medium') {
                filtered = filtered.filter(n => getNodeQualityScore(n) >= 40);
            }
            
            // åº”ç”¨å½“å‰æ’åº
            const sortBy = document.getElementById('sort-by').value;
            filtered = applySorting(filtered, sortBy);
            
            renderNodes(filtered);
            showToast(`æ˜¾ç¤º ${filtered.length} ä¸ªèŠ‚ç‚¹`);
        }
        
        function sortNodes(sortBy) {
            // è·å–å½“å‰ç­›é€‰åçš„èŠ‚ç‚¹
            const qualityFilter = document.getElementById('quality-filter').value;
            let filtered = [...globalNormalNodes];
            
            if (qualityFilter === 'high') {
                filtered = filtered.filter(n => getNodeQualityScore(n) >= 70);
            } else if (qualityFilter === 'medium') {
                filtered = filtered.filter(n => getNodeQualityScore(n) >= 40);
            }
            
            filtered = applySorting(filtered, sortBy);
            renderNodes(filtered);
        }
        
        function applySorting(nodes, sortBy) {
            const sorted = [...nodes];
            
            switch (sortBy) {
                case 'speed':
                    sorted.sort((a, b) => (b.speed || 0) - (a.speed || 0));
                    break;
                case 'latency':
                    // å»¶è¿Ÿè¶Šä½è¶Šå¥½ï¼Œæ— å»¶è¿Ÿæ•°æ®çš„æ’åé¢
                    sorted.sort((a, b) => {
                        const la = (a.latency || a.latency_ms) || 9999;
                        const lb = (b.latency || b.latency_ms) || 9999;
                        return la - lb;
                    });
                    break;
                case 'quality':
                default:
                    sorted.sort((a, b) => getNodeQualityScore(b) - getNodeQualityScore(a));
                    break;
            }
            
            return sorted;
        }

        // è¾…åŠ©åŠŸèƒ½
        function updateStats(data) {
            document.getElementById('node-count').innerText = data.length;
            document.getElementById('all-links').value = data.map(n => n.link).join('\n');
            
            // ç»Ÿè®¡å·²éªŒè¯èŠ‚ç‚¹ (æœ‰å»¶è¿Ÿæ•°æ®çš„)
            const verifiedCount = data.filter(n => n.latency_ms && n.latency_ms > 0).length;
            const verifiedEl = document.getElementById('monitor-verified');
            if (verifiedEl) {
                if (verifiedCount > 0) {
                    verifiedEl.innerText = `${verifiedCount}/${data.length}`;
                } else {
                    // æ²¡æœ‰æœåŠ¡ç«¯æµ‹è¯•æ•°æ®æ—¶ï¼Œæ˜¾ç¤ºå¾…æµ‹è¯•
                    verifiedEl.innerText = 'å¾…æµ‹è¯•';
                    verifiedEl.className = 'text-gray-400 font-mono';
                }
            }
            
            // è®¡ç®—è´¨é‡åˆ†æ•° (ä¸ createNodeCard é€»è¾‘ä¸€è‡´)
            const getQualityScore = (n) => {
                if (n.quality_score !== undefined && n.quality_score !== null) return n.quality_score;
                const speed = n.speed || 0;
                if (speed >= 10) return 80;
                if (speed >= 5) return 60;
                if (speed >= 2) return 40;
                return 20;
            };
            
            // ç»Ÿè®¡è´¨é‡åˆ†å¸ƒ
            const highQuality = data.filter(n => getQualityScore(n) >= 70).length;
            const mediumQuality = data.filter(n => getQualityScore(n) >= 40 && getQualityScore(n) < 70).length;
            console.log(`[Stats] èŠ‚ç‚¹è´¨é‡: ä¼˜è´¨${highQuality} ä¸­ç­‰${mediumQuality} ä¸€èˆ¬${data.length - highQuality - mediumQuality}`);
        }
        function getFlagEmoji(code) {
            if (!code || code === 'UNK') return 'ğŸŒ';
            const codePoints = code.toUpperCase().split('').map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }
        function copyLink(text) { navigator.clipboard.writeText(text).then(() => showToast('LINK COPIED')); }
        function copyAll() { navigator.clipboard.writeText(document.getElementById("all-links").value).then(() => showToast(`ALL NODES COPIED`)); }

        let toastTimeout;
        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 2000);
        }

        // ================= äº¤äº’ä¸å¼¹çª— =================
        function toggleAuthModal() {
            const modal = document.getElementById('auth-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) checkUserStatus();
        }
        function openCnModal() { renderCnNodes(); document.getElementById('cn-modal').classList.remove('hidden'); }
        function closeCnModal() { document.getElementById('cn-modal').classList.add('hidden'); }
        function closeQR() { document.getElementById('qr-modal').classList.add('hidden'); }

        const qrContainer = document.getElementById('qrcode');
        function showQR(link, title) {
            document.getElementById('qr-title').innerText = title;
            document.getElementById('qr-link-preview').innerText = link;
            qrContainer.innerHTML = '';
            document.getElementById('qr-modal').classList.remove('hidden');
            try {
                new QRCode(qrContainer, { text: link, width: 280, height: 280, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.L, quietZone: 2, quietZoneColor: '#ffffff' });
            } catch (e) { console.error(e); }
        }

        // ================= ç²¾ç¡®æµ‹é€Ÿé€»è¾‘ =================
        let currentTestNode = { link: '', name: '', nodeObject: null };
        let selectedTestSize = 0;

        function openPrecisionTestModal(link, nodeName) {
            // åœ¨å…¨å±€æ•°æ®ä¸­æŸ¥æ‰¾èŠ‚ç‚¹å¯¹è±¡
            let nodeObject = null;
            if (window.nodesData) {
                nodeObject = window.nodesData.find(n => n.link === link);
            }
            if (!nodeObject && window.globalCnNodes) {
                nodeObject = window.globalCnNodes.find(n => n.link === link);
            }
            
            console.log('===== æ‰“å¼€ç²¾å‡†æµ‹é€Ÿå¼¹æ¡† =====');
            console.log('èŠ‚ç‚¹åç§°:', nodeName);
            console.log('èŠ‚ç‚¹link:', link);
            console.log('æ‰¾åˆ°çš„èŠ‚ç‚¹å¯¹è±¡:', nodeObject);
            if (nodeObject) {
                console.log('èŠ‚ç‚¹host:', nodeObject.host);
                console.log('èŠ‚ç‚¹port:', nodeObject.port);
                console.log('èŠ‚ç‚¹å½“å‰é€Ÿåº¦:', nodeObject.speed);
            }
            
            currentTestNode = { link, name: nodeName, nodeObject };
            selectedTestSize = 0;
            document.getElementById('precision-test-modal').classList.remove('hidden');
            // é‡ç½® UI åˆ°æ–‡ä»¶å¤§å°é€‰æ‹©
            document.getElementById('precision-test-content').classList.remove('hidden');
            document.getElementById('precision-test-confirm').classList.add('hidden');
            document.getElementById('precision-test-running').classList.add('hidden');
            document.getElementById('precision-test-result').classList.add('hidden');
        }

        function closePrecisionTestModal() {
            document.getElementById('precision-test-modal').classList.add('hidden');
            selectedTestSize = 0;
        }

        function selectPrecisionTestSize(sizeInMb) {
            selectedTestSize = sizeInMb;
            // æ˜¾ç¤ºç¡®è®¤ç•Œé¢
            document.getElementById('precision-test-content').classList.add('hidden');
            document.getElementById('precision-test-confirm').classList.remove('hidden');
            document.getElementById('precision-test-running').classList.add('hidden');
            document.getElementById('precision-test-result').classList.add('hidden');
            
            // æ›´æ–°ç¡®è®¤ä¿¡æ¯
            document.getElementById('confirm-test-size').innerText = `${sizeInMb} MB`;
            document.getElementById('confirm-traffic').innerText = `${sizeInMb} MB`;
        }

        function cancelPrecisionTest() {
            // è¿”å›æ–‡ä»¶å¤§å°é€‰æ‹©
            document.getElementById('precision-test-content').classList.remove('hidden');
            document.getElementById('precision-test-confirm').classList.add('hidden');
            selectedTestSize = 0;
        }

        function confirmPrecisionTest() {
            if (selectedTestSize > 0) {
                startPrecisionTest(selectedTestSize);
            }
        }

        let progressInterval = null;
        let currentProgress = 0;

        async function startPrecisionTest(fileSizeMs) {
            document.getElementById('precision-test-confirm').classList.add('hidden');
            document.getElementById('precision-test-running').classList.remove('hidden');
            document.getElementById('precision-test-result').classList.add('hidden');
            
            // é‡ç½®è¿›åº¦æ¡
            currentProgress = 0;
            updateProgressBar(0);
            
            // å¯åŠ¨æ¨¡æ‹Ÿè¿›åº¦æ¡ï¼ˆå¹³æ»‘å¢é•¿åˆ° 95%ï¼‰
            startProgressSimulation();
            
            try {
                console.log(`å¼€å§‹ç²¾ç¡®æµ‹é€Ÿ | èŠ‚ç‚¹: ${currentTestNode.name} | æ–‡ä»¶å¤§å°: ${fileSizeMs}MB`);
                
                // è°ƒç”¨åç«¯ API
                const response = await fetch(`${VIPER_API_BASE}/api/nodes/precision-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        proxy_url: currentTestNode.link,
                        test_file_size: fileSizeMs
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('ç²¾ç¡®æµ‹é€Ÿç»“æœ:', data);

                // åœæ­¢æ¨¡æ‹Ÿè¿›åº¦ï¼Œè®¾ç½®ä¸º 100%
                stopProgressSimulation();
                updateProgressBar(100);
                
                // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºç»“æœ
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // æ˜¾ç¤ºç»“æœ
                showPrecisionTestResult(data);
                
            } catch (error) {
                console.error('ç²¾ç¡®æµ‹é€Ÿå¤±è´¥:', error);
                stopProgressSimulation();
                showPrecisionTestResult({
                    status: 'error',
                    speed_mbps: 0,
                    message: `æµ‹é€Ÿå¤±è´¥: ${error.message}`
                });
            }
        }

        function startProgressSimulation() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            currentProgress = 0;
            
            // æ¯ 150ms å¢åŠ è¿›åº¦
            progressInterval = setInterval(() => {
                if (currentProgress < 95) {
                    // ä½¿ç”¨éçº¿æ€§å¢é•¿ï¼Œå¼€å§‹å¿«ï¼Œåé¢æ…¢
                    const increment = Math.max(0.5, (95 - currentProgress) / 20);
                    currentProgress = Math.min(95, currentProgress + increment);
                    updateProgressBar(Math.floor(currentProgress));
                }
            }, 150);
        }

        function stopProgressSimulation() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function updateProgressBar(percent) {
            const progressBar = document.querySelector('#precision-test-running .bg-purple-600');
            const progressText = document.querySelector('#precision-test-running .text-center');
            
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
            if (progressText) {
                progressText.textContent = percent + '%';
            }
        }

        function showPrecisionTestResult(result) {
            document.getElementById('precision-test-running').classList.add('hidden');
            document.getElementById('precision-test-result').classList.remove('hidden');
            
            if (result.status === 'success' || result.status === 'partial_success') {
                document.getElementById('precision-test-result-title').innerText = `âœ… ${result.message}`;
                document.getElementById('precision-test-speed').innerText = `${result.speed_mbps} MB/s`;
                document.getElementById('precision-test-time').innerText = `${result.download_time_seconds}s`;
                document.getElementById('precision-test-traffic').innerText = `${result.traffic_consumed_mb}MB`;
                
                console.log('===== æµ‹é€Ÿå®Œæˆï¼Œå‡†å¤‡æ›´æ–°UI =====');
                console.log('æµ‹é€Ÿç»“æœé€Ÿåº¦:', result.speed_mbps, 'MB/s');
                console.log('currentTestNode:', currentTestNode);
                
                // ç«‹å³æ›´æ–°èŠ‚ç‚¹æ•°æ®å’Œå¡ç‰‡æ˜¾ç¤º
                if (currentTestNode.nodeObject) {
                    console.log('æ›´æ–°å‰ - èŠ‚ç‚¹å¯¹è±¡é€Ÿåº¦:', currentTestNode.nodeObject.speed);
                    currentTestNode.nodeObject.speed = result.speed_mbps;
                    console.log('æ›´æ–°å - èŠ‚ç‚¹å¯¹è±¡é€Ÿåº¦:', currentTestNode.nodeObject.speed);
                    
                    // ç›´æ¥æ›´æ–°DOM
                    updateNodeCardUI(currentTestNode.nodeObject);
                    
                    // ç«‹å³è¿›è¡Œå»¶è¿Ÿæµ‹é€Ÿï¼ˆä¸ç­‰å¾…ç”¨æˆ·å…³é—­å¼¹æ¡†ï¼‰
                    console.log('å¼€å§‹è‡ªåŠ¨å»¶è¿Ÿæµ‹é€Ÿ...');
                    testLatency(currentTestNode.link, currentTestNode.name);
                } else {
                    console.error('âŒ currentTestNode.nodeObject ä¸ºç©ºï¼Œæ— æ³•æ›´æ–°');
                }
            } else {
                document.getElementById('precision-test-result-title').innerText = `âŒ æµ‹é€Ÿå¤±è´¥`;
                document.getElementById('precision-test-speed').innerText = '-- MB/s';
                document.getElementById('precision-test-time').innerText = '-- s';
                document.getElementById('precision-test-traffic').innerText = `${result.message || 'æœªçŸ¥é”™è¯¯'}`;
            }
        }

        function updateNodeCardUI(node) {
            console.log('===== updateNodeCardUI å¼€å§‹ =====');
            console.log('èŠ‚ç‚¹å¯¹è±¡:', node);
            console.log('èŠ‚ç‚¹host:', node.host, 'èŠ‚ç‚¹port:', node.port);
            
            const rawSpeed = node.speed || 0;
            const displaySpeed = Math.min(rawSpeed, 100).toFixed(1);
            const speedPercent = Math.min((rawSpeed / 100) * 100, 100);
            
            console.log('åŸå§‹é€Ÿåº¦:', rawSpeed);
            console.log('æ˜¾ç¤ºé€Ÿåº¦:', displaySpeed);
            console.log('è¿›åº¦æ¡ç™¾åˆ†æ¯”:', speedPercent);
            
            // é‡æ–°è®¡ç®—è´¨é‡è¯„åˆ†
            let qualityScore;
            if (rawSpeed >= 10) qualityScore = 80;
            else if (rawSpeed >= 5) qualityScore = 60;
            else if (rawSpeed >= 2) qualityScore = 40;
            else qualityScore = 20;
            
            // ç¡®å®šæ ·å¼
            let speedColor = 'text-gray-500', barColor = 'bg-gray-700';
            if (qualityScore >= 70) {
                speedColor = 'text-emerald-400';
                barColor = 'bg-emerald-500';
            } else if (qualityScore >= 40) {
                speedColor = 'text-amber-400';
                barColor = 'bg-amber-500';
            } else if (qualityScore > 0) {
                speedColor = 'text-rose-400';
                barColor = 'bg-rose-500';
            }
            
            console.log('æ ·å¼ - speedColor:', speedColor, 'barColor:', barColor);
            
            // å°è¯•ç”¨IDæ‰¾åˆ°å¡ç‰‡
            const nodeId = `node-${node.host}-${node.port}`.replace(/\./g, '-');
            console.log('è®¡ç®—çš„èŠ‚ç‚¹ID:', nodeId);
            
            let card = document.getElementById(nodeId);
            console.log('æ‰¾åˆ°çš„å¡ç‰‡å…ƒç´ :', card);
            
            if (card) {
                console.log('âœ… é€šè¿‡IDæ‰¾åˆ°èŠ‚ç‚¹å¡ç‰‡:', nodeId);
                
                // è·å–text-rightå®¹å™¨
                const textRight = card.querySelector('div.text-right');
                console.log('text-rightå®¹å™¨:', textRight);
                
                if (textRight) {
                    // æ›´æ–°é€Ÿåº¦æ˜¾ç¤º - ç¬¬ä¸€ä¸ªå­div
                    const speedDiv = textRight.children[0];
                    console.log('speedDiv:', speedDiv);
                    
                    if (speedDiv) {
                        speedDiv.className = `font-mono text-xs font-bold ${speedColor}`;
                        speedDiv.innerHTML = `${displaySpeed} <span class="text-[9px] opacity-70">MB/s</span>`;
                        console.log('âœ… å·²æ›´æ–°é€Ÿåº¦:', displaySpeed);
                    }
                }
                
                // æ›´æ–°è¿›åº¦æ¡
                const progressContainer = card.querySelector('div.overflow-hidden.h-1\\.5, div[class*="h-1.5"]');
                console.log('è¿›åº¦æ¡å®¹å™¨:', progressContainer);
                
                if (progressContainer) {
                    const innerBar = progressContainer.querySelector('div');
                    console.log('è¿›åº¦æ¡å†…éƒ¨å…ƒç´ :', innerBar);
                    
                    if (innerBar) {
                        innerBar.style.width = speedPercent + '%';
                        innerBar.className = `h-full ${barColor} transition-all duration-700`;
                        console.log('âœ… å·²æ›´æ–°è¿›åº¦æ¡:', speedPercent + '%');
                    }
                }
            } else {
                console.error('âŒ æœªæ‰¾åˆ°èŠ‚ç‚¹å¡ç‰‡, nodeId:', nodeId);
                console.log('é¡µé¢ä¸Šçš„æ‰€æœ‰å¡ç‰‡ID:');
                document.querySelectorAll('.glass-card[id]').forEach(c => {
                    console.log('  -', c.id);
                });
            }
        }

        async function testLatency(proxyUrl, nodeName) {
            try {
                console.log(`å¼€å§‹å»¶è¿Ÿæµ‹é€Ÿ: ${nodeName}`);
                const response = await fetch(`${VIPER_API_BASE}/api/nodes/latency-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ proxy_url: proxyUrl })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('å»¶è¿Ÿæµ‹é€Ÿç»“æœ:', data);
                    
                    // æ›´æ–°èŠ‚ç‚¹å»¶è¿Ÿæ•°æ®
                    if (currentTestNode.nodeObject && data.latency) {
                        currentTestNode.nodeObject.latency = data.latency;
                        updateNodeLatencyUI(currentTestNode.nodeObject);
                    }
                }
            } catch (error) {
                console.error('å»¶è¿Ÿæµ‹é€Ÿå¤±è´¥:', error);
            }
        }

        function updateNodeLatencyUI(node) {
            console.log('æ›´æ–°èŠ‚ç‚¹å»¶è¿ŸUI - å¯»æ‰¾èŠ‚ç‚¹:', `${node.host}:${node.port}`);
            
            const latency = node.latency || 0;
            const latencyText = latency > 0 ? `${Math.round(latency)}ms` : '--';
            const latencyColor = latency > 0 ? 
                (latency < 300 ? 'text-emerald-400' : 
                 latency < 800 ? 'text-amber-400' : 
                 'text-rose-400') : 
                'text-gray-500';
            
            // ç”¨IDç›´æ¥æ‰¾åˆ°å»¶è¿Ÿæ˜¾ç¤ºå…ƒç´ 
            const nodeId = `node-${node.host}-${node.port}`.replace(/\./g, '-');
            const latencyElement = document.getElementById(`${nodeId}-latency`);
            
            if (latencyElement) {
                console.log('âœ… æ‰¾åˆ°å»¶è¿Ÿæ˜¾ç¤ºå…ƒç´ :', `${nodeId}-latency`);
                latencyElement.className = `font-mono text-[10px] ${latencyColor} flex items-center justify-end gap-1`;
                latencyElement.innerHTML = `<span class="opacity-50 text-[8px]">âš¡</span>${latencyText}`;
                console.log('âœ… å·²æ›´æ–°å»¶è¿Ÿ:', latencyText);
            } else {
                console.warn('âŒ æœªæ‰¾åˆ°å»¶è¿Ÿæ˜¾ç¤ºå…ƒç´ :', `${nodeId}-latency`);
            }
        }

        // ================= ç™»å½•æ³¨å†Œé€»è¾‘ =================
        async function checkUserStatus() {
            const { user, isVip, vipDate } = await getVipStatus();
            updateAuthUI(user, isVip, vipDate);
        }

        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            if (!email || !password) return showToast("MISSING CREDENTIALS");
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                showToast("ACCESS GRANTED");
                toggleAuthModal();
                fetchData();
            } catch (e) { showToast("LOGIN FAILED"); }
        }

        async function handleRegister() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            if (!email || !password) return showToast("MISSING CREDENTIALS");
            try {
                const { data, error } = await supabaseClient.auth.signUp({ email, password });
                if (error) throw error;
                if (data.session) {
                    showToast("REGISTRATION SUCCESSFUL");
                    toggleAuthModal();
                    fetchData();
                } else showToast("CHECK EMAIL");
            } catch (e) { showToast("ERROR: " + e.message); }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            toggleAuthModal();
            location.reload();
        }

        async function redeemKami() {
            const code = document.getElementById('kami-code').value;
            if (!code) return showToast("ENTER CODE");
            try {
                const { data, error } = await supabaseClient.rpc('redeem_kami', { code_input: code });
                if (error) throw error;
                showToast(data || "ACTIVATED");
                checkUserStatus();
                fetchData();
            } catch (e) { showToast("SYSTEM ERROR"); }
        }

        // ================= âš¡ åŒåŒºåŸŸæµ‹é€Ÿæ§åˆ¶ =================
        let speedTestInProgress = false;

        function toggleSpeedTestModal() {
            const modal = document.getElementById('speedtest-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                // æ‰“å¼€æ¨¡æ€æ¡†æ—¶æ£€æŸ¥å½“å‰çŠ¶æ€
                checkSpeedTestStatus();
            }
        }

        async function checkSpeedTestStatus() {
            try {
                const res = await fetch(`${VIPER_API_BASE}/nodes/stats`);
                if (!res.ok) throw new Error('Failed to fetch status');
                const data = await res.json();
                
                // æ£€æŸ¥æ˜¯å¦æ­£åœ¨æµ‹é€Ÿï¼ˆé€šè¿‡æ—¥å¿—åˆ¤æ–­ï¼‰
                const logs = data.logs || [];
                const allLogsText = logs.join('\n');
                
                // ä¸¥æ ¼åˆ¤å®šï¼šçœ‹æœ€åæ˜¯å¦æœ‰"ğŸ‰ æµ‹è¯•å®Œæˆ"çš„æ—¥å¿—
                const completionRegex = /ğŸ‰\s*æµ‹è¯•å®Œæˆï¼æœ‰æ•ˆèŠ‚ç‚¹:\s*(\d+)\/(\d+)/;
                const isCompleted = completionRegex.test(allLogsText);
                const isRunning = !isCompleted && allLogsText.includes('å¯åŠ¨é«˜çº§åŒåœ°åŒºæµ‹é€Ÿ');
                
                speedTestInProgress = isRunning;
                updateSpeedTestUI(isRunning);
            } catch (e) {
                console.warn('[SpeedTest] Failed to check status:', e);
            }
        }

        function updateSpeedTestUI(isRunning) {
            const idleSection = document.getElementById('speedtest-idle');
            const runningSection = document.getElementById('speedtest-running');
            const doneSection = document.getElementById('speedtest-done');
            const btn = document.getElementById('speedtest-btn');
            
            if (isRunning) {
                idleSection.classList.add('hidden');
                runningSection.classList.remove('hidden');
                doneSection.classList.add('hidden');
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                // å¼€å§‹è½®è¯¢
                monitorSpeedTest();
            } else {
                idleSection.classList.remove('hidden');
                runningSection.classList.add('hidden');
                doneSection.classList.add('hidden');
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        async function startSpeedTest() {
            try {
                const btn = document.querySelector('#speedtest-idle button');
                if (btn) btn.disabled = true;
                
                const res = await fetch(`${VIPER_API_BASE}/api/sync/poll-now`, {
                    method: 'POST',
                    cache: 'no-store'
                });
                
                if (!res.ok) throw new Error('Failed to start speed test');
                
                speedTestInProgress = true;
                updateSpeedTestUI(true);
                
                showToast('åŒåŒºæµ‹é€Ÿå·²å¯åŠ¨ï¼Œè¯·ç­‰å¾… 5-10 åˆ†é’Ÿ...');
                
            } catch (e) {
                console.error('[SpeedTest] Failed to start:', e);
                showToast('å¯åŠ¨å¤±è´¥: ' + e.message);
            }
        }

        let speedTestMonitorInterval = null;
        async function monitorSpeedTest() {
            // æ¸…é™¤æ—§çš„ç›‘æ§
            if (speedTestMonitorInterval) clearInterval(speedTestMonitorInterval);
            
            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
            await updateSpeedTestProgress();
            
            // é¢‘ç¹æ£€æŸ¥ï¼ˆæ¯ 10 ç§’ï¼‰è€Œä¸æ˜¯ 3 åˆ†é’Ÿ
            // è¿™æ ·å¯ä»¥å¿«é€Ÿå“åº”æµ‹é€Ÿå®Œæˆä¿¡å·ï¼ˆé€šå¸¸ 10-30 ç§’å†…ï¼‰
            speedTestMonitorInterval = setInterval(async () => {
                await updateSpeedTestProgress();
            }, 10 * 1000);
        }

        async function updateSpeedTestProgress() {
            try {
                const res = await fetch(`${VIPER_API_BASE}/nodes/stats`);
                if (!res.ok) return;
                const data = await res.json();
                
                const logs = data.logs || [];
                const allLogsText = logs.join('\n');
                
                // ğŸ”¥ æ”¹è¿›ï¼šåŒæ—¶æ£€æŸ¥ä¸¤ä¸ªå®Œæˆä¿¡å·
                // 1. åŸºç¡€æ£€æµ‹å®Œæˆï¼šğŸ‰ èŠ‚ç‚¹æ£€æµ‹å®Œæˆï¼å¯ç”¨èŠ‚ç‚¹: X/Y
                const basicCompletionRegex = /ğŸ‰\s*èŠ‚ç‚¹æ£€æµ‹å®Œæˆï¼å¯ç”¨èŠ‚ç‚¹:\s*(\d+)\/(\d+)/;
                const basicCompleted = basicCompletionRegex.test(allLogsText);
                
                // 2. viper-node-store åŒæ­¥å®Œæˆï¼šâœ… viper-node-store åŒæ­¥å®Œæˆï¼
                const syncCompletionRegex = /âœ…\s*viper-node-store åŒæ­¥å®Œæˆï¼/;
                const syncCompleted = syncCompletionRegex.test(allLogsText);
                
                // 3. æ£€æŸ¥æ˜¯å¦æœ‰åŒæ­¥å¤±è´¥çš„æƒ…å†µ
                const syncFailedRegex = /âš ï¸\s*viper-node-store åŒæ­¥å¤±è´¥/;
                const syncFailed = syncFailedRegex.test(allLogsText);
                
                console.log('[Monitor] Status - basicCompleted:', basicCompleted, 'syncCompleted:', syncCompleted, 'syncFailed:', syncFailed);
                
                // ğŸ”¥ æ”¹è¿›ï¼šåŸºç¡€æ£€æµ‹å®Œæˆ + (åŒæ­¥å®Œæˆ OR åŒæ­¥å¤±è´¥) å°±è¡¨ç¤ºæ•´ä¸ªæµç¨‹å®Œæˆ
                const isFullyCompleted = basicCompleted && (syncCompleted || syncFailed);
                
                if (isFullyCompleted) {
                    speedTestInProgress = false;
                    if (speedTestMonitorInterval) clearInterval(speedTestMonitorInterval);
                    
                    // æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                    document.getElementById('speedtest-idle').classList.add('hidden');
                    document.getElementById('speedtest-running').classList.add('hidden');
                    document.getElementById('speedtest-done').classList.remove('hidden');
                    
                    if (syncCompleted) {
                        document.getElementById('speedtest-result-msg').innerText = 'âœ… åŒåŒºæµ‹é€Ÿå®Œæˆï¼æ•°æ®å·²åŒæ­¥åˆ° viper-node-storeï¼Œæ­£åœ¨åˆ·æ–°...';
                    } else if (syncFailed) {
                        document.getElementById('speedtest-result-msg').innerText = 'âš ï¸ åŒåŒºæµ‹é€Ÿå®Œæˆä½†åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Supabase é…ç½®...';
                    }
                    
                    // ğŸ”¥ æ”¹è¿›ï¼šåªéœ€ 2-5 ç§’å³å¯åˆ·æ–°ï¼ˆå› ä¸ºæ•°æ®å·²ç»åŒæ­¥ï¼‰
                    setTimeout(() => {
                        fetchData();
                        toggleSpeedTestModal();
                        showToast('âœ… æµ‹é€Ÿå®Œæˆï¼æ•°æ®å·²æ›´æ–°');
                    }, 2000);
                } else if (basicCompleted) {
                    // ğŸ”¥ æ–°å¢ï¼šåŸºç¡€æ£€æµ‹å®Œæˆä½†ç­‰å¾…åŒæ­¥çš„çŠ¶æ€æç¤º
                    document.getElementById('speedtest-result-msg').innerText = 'â³ åŸºç¡€æ£€æµ‹å®Œæˆï¼Œæ­£åœ¨åŒæ­¥åˆ° viper-node-store...';
                    document.getElementById('speedtest-progress').innerText = '95%';
                    document.getElementById('speedtest-bar').style.width = '95%';
                } else {
                    // æå–è¿›åº¦ä¿¡æ¯
                    const mainlandMatch = allLogsText.match(/\[Aliyun\][\s\S]*?(\d+)\s*\/\s*(\d+)/);
                    const overseasMatch = allLogsText.match(/\[Cloudflare\][\s\S]*?(\d+)\s*\/\s*(\d+)/);
                    
                    let mainlandMsg = 'å¤„ç†ä¸­...';
                    let overseasMsg = 'å¤„ç†ä¸­...';
                    let totalProgress = 0;
                    
                    if (mainlandMatch) {
                        mainlandMsg = `${mainlandMatch[1]}/${mainlandMatch[2]}`;
                        totalProgress = (parseInt(mainlandMatch[1]) / parseInt(mainlandMatch[2])) * 50;
                    }
                    
                    if (overseasMatch) {
                        overseasMsg = `${overseasMatch[1]}/${overseasMatch[2]}`;
                        totalProgress += (parseInt(overseasMatch[1]) / parseInt(overseasMatch[2])) * 50;
                    }
                    
                    document.getElementById('mainland-status').innerText = mainlandMsg;
                    document.getElementById('overseas-status').innerText = overseasMsg;
                    document.getElementById('speedtest-progress').innerText = Math.round(totalProgress) + '%';
                    document.getElementById('speedtest-bar').style.width = totalProgress + '%';
                }
            } catch (e) {
                console.warn('[Monitor] Failed to update progress:', e);
            }
        }

        // ================= ğŸš€ [æé€Ÿæ¥å…¥] å¹½çµæ³¨å…¥ä¸å¤„ç†é€»è¾‘ =================

        // 1. ä¸šåŠ¡é€»è¾‘
        async function handleQuickStart() {
            const btn = document.getElementById('ghost-quick-btn');
            let originalText = '';
            if (btn) {
                originalText = btn.innerHTML;
                btn.innerHTML = '<span class="animate-spin">â†»</span> ç³»ç»Ÿæ¥å…¥ä¸­...';
                btn.disabled = true;
            }

            try {
                const timestamp = Date.now().toString().slice(-4);
                const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
                const username = `VIPER-${randomStr}-${timestamp}`;
                const password = `Viper#${Date.now().toString(36).slice(-8)}!`;
                // ä½¿ç”¨ shadow-network åŸŸåï¼Œçœ‹èµ·æ¥æ›´ä¸“ä¸š
                const email = `agent.${randomStr.toLowerCase()}.${timestamp}@shadow-network.com`;

                console.log(`[QuickStart] Generating Identity: ${username}`);

                // æ³¨å†Œ
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email, password: password,
                    options: { data: { username: username } }
                });

                if (error) throw error;

                // è‡ªåŠ¨ç™»å½• (æ— éœ€äºŒæ¬¡ signInï¼ŒsignUp åœ¨å…³é—­éªŒè¯æ—¶ä¼šç›´æ¥è¿”å› session)
                if (!data.session) {
                    // å¦‚æœä¸‡ä¸€æ²¡è¿”å›sessionï¼Œè¡¥åˆ€ç™»å½•
                    const { error: loginError } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (loginError) throw loginError;
                }

                // æœ¬åœ°è®°å¿†
                localStorage.setItem('shadow_user_email', email);
                localStorage.setItem('shadow_user_pass', password);

                // UI åé¦ˆ
                showIdentityCard(username, password);
                document.getElementById('auth-modal').classList.add('hidden');

                // åˆ·æ–°æ•°æ®ä»¥åº”ç”¨ç™»å½•çŠ¶æ€
                fetchData();

            } catch (err) {
                console.error(err);
                alert('æ¥å…¥ä¸­æ–­: ' + err.message);
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        // 2. èº«ä»½å¡æ˜¾ç¤º
        function showIdentityCard(user, pass) {
            document.getElementById('new-username').innerText = user;
            document.getElementById('new-password').innerText = pass;
            window.currentIdentity = { user, pass };

            const modal = document.getElementById('identity-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // 3. å¤åˆ¶ä¸ä¸‹è½½
        function copyIdentity() {
            const { user, pass } = window.currentIdentity;
            navigator.clipboard.writeText(`ID: ${user}\nKey: ${pass}`).then(() => {
                const tip = document.getElementById('copy-tip');
                tip.classList.remove('opacity-0');
                setTimeout(() => tip.classList.add('opacity-0'), 1500);
                enableEnterButton();
            });
        }
        function downloadIdentity() {
            const { user, pass } = window.currentIdentity;
            const text = `=== Shadow Nexus ===\nID: ${user}\nKey: ${pass}\nGenerated: ${new Date().toLocaleString()}`;
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Shadow-ID-${user}.txt`;
            a.click();
            enableEnterButton();
        }
        function enableEnterButton() {
            const btn = document.getElementById('btn-enter');
            btn.disabled = false;
            btn.innerText = "æˆ‘å·²ä¿å­˜ï¼Œè¿›å…¥ç³»ç»Ÿ (Enter)";
            btn.classList.remove('bg-gray-700', 'text-gray-500', 'cursor-not-allowed');
            btn.classList.add('bg-cyan-600', 'text-white', 'hover:bg-cyan-500');
        }
        function closeIdentityModal() {
            document.getElementById('identity-modal').classList.add('hidden');
            // æ­¤æ—¶å·²ç»æ˜¯ç™»å½•çŠ¶æ€ï¼Œç›´æ¥åˆ·æ–°æ•°æ®å³å¯ï¼Œæ— éœ€é‡è½½é¡µé¢
            fetchData();
        }

        // ================= åŒæ­¥æ—¶é—´æ˜¾ç¤º =================
        
        /**
         * æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´æ˜¾ç¤º
         * @param {number} minutesAgo åˆ†é’Ÿæ•°
         * @returns {string} æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²
         */
        function formatTimeAgo(minutesAgo) {
            if (minutesAgo < 1) return 'åˆšåˆš';
            if (minutesAgo < 60) return `${minutesAgo}åˆ†é’Ÿå‰`;
            const hoursAgo = Math.floor(minutesAgo / 60);
            if (hoursAgo < 24) return `${hoursAgo}å°æ—¶å‰`;
            const daysAgo = Math.floor(hoursAgo / 24);
            return `${daysAgo}å¤©å‰`;
        }

        /**
         * æ‰‹åŠ¨è§¦å‘åç«¯è½®è¯¢å¹¶åˆ·æ–°æ˜¾ç¤º
         * ç”¨äºç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®æ—¶ä¸»åŠ¨åŒæ­¥æ•°æ®
         */
        async function triggerPollAndRefresh() {
            try {
                console.log('ğŸ”„ è§¦å‘æ‰‹åŠ¨è½®è¯¢...');
                const response = await fetch(`${VIPER_API_BASE}/api/sync/poll-now`, {
                    method: 'POST',
                    cache: 'no-store'
                });
                
                if (response.ok) {
                    console.log('âœ… è½®è¯¢è¯·æ±‚å·²å‘é€');
                    // ç­‰å¾…2ç§’è®©åç«¯å¤„ç†ï¼Œç„¶ååˆ·æ–°æ˜¾ç¤º
                    setTimeout(() => {
                        fetchSyncInfo();
                    }, 2000);
                } else {
                    console.error('è½®è¯¢è¯·æ±‚å¤±è´¥:', response.status);
                    setTimeout(() => fetchSyncInfo(), 1000);
                }
            } catch (error) {
                console.error('è§¦å‘è½®è¯¢é”™è¯¯:', error);
                // å³ä½¿è½®è¯¢å¤±è´¥ï¼Œä¹Ÿå°è¯•åˆ·æ–°æ˜¾ç¤º
                setTimeout(() => fetchSyncInfo(), 1000);
            }
        }

        /**
         * è·å–å¹¶æ˜¾ç¤ºåŒæ­¥ä¿¡æ¯
         * æ”¯æŒä¸¤ä¸ªæ•°æ®æº:
         * 1. /api/sync-info - åç«¯API (é¦–é€‰)
         * 2. window.nodesData - å‰ç«¯æœ¬åœ°æ•°æ®
         */
        async function fetchSyncInfo() {
            try {
                const timeDisplay = document.getElementById('sync-time-display');
                const nodesCountDisplay = document.getElementById('nodes-count');
                
                // ä¼˜å…ˆä»APIè·å–
                try {
                    const response = await fetch(`${VIPER_API_BASE}/api/sync-info`, {
                        method: 'GET',
                        cache: 'no-store',
                        timeout: 3000
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const displayText = formatTimeAgo(data.minutes_ago);
                        
                        if (timeDisplay) {
                            timeDisplay.textContent = displayText;
                        }
                        if (nodesCountDisplay) {
                            nodesCountDisplay.textContent = data.active_count || 0;
                        }
                        
                        // æ›´æ–°åï¼Œç»§ç»­30ç§’åçš„ä¸‹ä¸€æ¬¡æ›´æ–°
                        setTimeout(fetchSyncInfo, 30000);
                        return;
                    }
                } catch (apiError) {
                    console.debug('API fetch failed, using local data:', apiError.message);
                }
                
                // é™çº§æ–¹æ¡ˆ: ä»å‰ç«¯æœ¬åœ°æ•°æ®è·å–
                if (window.nodesData && Array.isArray(window.nodesData)) {
                    const activeCount = window.nodesData.length;
                    const displayText = 'åˆšåˆš';
                    
                    if (timeDisplay) {
                        timeDisplay.textContent = displayText;
                    }
                    if (nodesCountDisplay) {
                        nodesCountDisplay.textContent = activeCount;
                    }
                } else {
                    if (timeDisplay) {
                        timeDisplay.textContent = 'æ­£åœ¨åŠ è½½...';
                    }
                    if (nodesCountDisplay) {
                        nodesCountDisplay.textContent = 0;
                    }
                }
                
                // ç»§ç»­30ç§’åçš„ä¸‹ä¸€æ¬¡æ›´æ–°
                setTimeout(fetchSyncInfo, 30000);
            } catch (error) {
                console.error('Error in fetchSyncInfo:', error);
                const timeDisplay = document.getElementById('sync-time-display');
                if (timeDisplay) {
                    timeDisplay.textContent = 'åŠ è½½å¤±è´¥';
                }
                setTimeout(fetchSyncInfo, 30000);
            }
        }

        // 4. [å¹½çµæ³¨å…¥å™¨]
        function injectGhostButton() {
            const btnContainer = document.querySelector('#login-section .flex.gap-3');
            if (btnContainer && !document.getElementById('ghost-quick-btn')) {
                const quickBtn = document.createElement('button');
                quickBtn.id = 'ghost-quick-btn';
                quickBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                    æé€Ÿæ¥å…¥ (Quick Start)
                `;
                quickBtn.className = "w-full mt-3 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-bold py-2.5 px-4 rounded-lg shadow-lg shadow-cyan-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2 text-sm";
                quickBtn.onclick = handleQuickStart;
                btnContainer.parentNode.insertBefore(quickBtn, btnContainer.nextSibling);
            }
        }

        const observer = new MutationObserver((mutations) => injectGhostButton());
        observer.observe(document.body, { childList: true, subtree: true, attributes: true });
        setTimeout(injectGhostButton, 500);

    </script>
</body>

</html>