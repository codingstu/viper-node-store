# 🚀 登录/VIP 系统快速测试指南

## 前置条件

- ✅ Supabase 项目已配置
- ✅ profiles 表存在（vip_until 字段）
- ✅ RPC 函数 redeem_kami 已创建
- ✅ 前端开发服务器已运行：`npm run dev`

---

## 快速测试流程

### 1️⃣ 测试游客模式（无登录）

```
操作步骤:
1. 打开 http://localhost:5174
2. 观察顶部导航栏
   ✓ 应显示 "🔐 登录" 按钮
   ✓ 不显示 VIP/用户徽章
3. 观察节点列表
   ✓ 应只显示前 20 个节点
   ✓ 网格中显示"总节点数"应为 ≤ 20
```

### 2️⃣ 测试极速注册（推荐）

```
操作步骤:
1. 点击 "🔐 登录" 按钮
2. 切换到 "注册" 标签页
3. 点击紫色按钮 "🚀 极速注册 (一键接入)"
4. 等待 1-2 秒，应出现身份卡弹窗
5. 复制账户信息：点击 "📋 复制账户信息"
6. 关闭身份卡弹窗
7. 顶部导航栏应显示:
   ✓ 账户名称（VIPER-XXXX-YYYY）
   ✓ "📌 普通用户" 徽章（灰色）
8. 节点列表应仍为 20 个（非 VIP 限制）
```

### 3️⃣ 测试邮箱注册

```
操作步骤:
1. 点击 "🔐 登录" 按钮
2. 切换到 "注册" 标签页
3. 填表单：
   - 邮箱: test123@example.com
   - 用户名: TestUser123
   - 密码: Secure#Password123
4. 点击 "注册" 按钮
5. 等待 1-2 秒，应自动登录并关闭
6. 顶部应显示新用户名和"📌 普通用户"徽章
```

### 4️⃣ 测试激活码升级（需真实激活码）

```
前置: 已有一个普通用户账户登录

操作步骤:
1. 点击顶部 "👤 账户" 按钮（或用户名旁的徽章）
2. 模态框中应显示 "激活码" 标签页（仅已登录时可见）
3. 输入有效的激活码（格式: XXXX-XXXX-XXXX）
4. 点击 "兑换激活码" 按钮
5. 成功后应显示: "✅ 激活成功！您已升级为 VIP 用户"
6. 页面自动关闭，返回主界面
7. 顶部徽章应变为 "⭐ VIP"（黄色）
8. 节点列表应显示全部节点（>20 个）
```

### 5️⃣ 测试邮箱密码登录

```
前置: 已注册过的账户（邮箱/密码）

操作步骤:
1. 点击 "🔐 登录" 按钮
2. "登录" 标签页应默认选中
3. 填表单：
   - 邮箱: [已注册的邮箱]
   - 密码: [注册时的密码]
4. 点击 "登录" 按钮
5. 等待 1-2 秒，应自动登录并关闭
6. 顶部显示用户名和权限徽章
```

### 6️⃣ 测试登出

```
前置: 已登录用户

操作步骤:
1. 点击顶部 "👤 账户" 按钮
2. 模态框底部应显示 "登出" 按钮
3. 点击 "登出"
4. 模态框关闭
5. 顶部恢复显示 "🔐 登录" 按钮
6. 节点限制恢复为 20 个
```

---

## 预期行为对照表

### 顶部导航栏变化

| 状态 | 显示内容 | 按钮 |
|------|---------|------|
| 游客 | - | 🔐 登录 |
| 普通用户 | TestUser \| 📌 普通用户 | 👤 账户 |
| VIP用户 | TestUser \| ⭐ VIP | 👤 账户 |

### 节点列表行为

| 用户类型 | 显示节点数 | 备注 |
|---------|----------|------|
| 游客 | ≤ 20 个 | displayedNodes 已自动应用限制 |
| 普通用户 | ≤ 20 个 | 相同限制 |
| VIP用户 | 全部 | 无限制 |

---

## 浏览器控制台检查

打开 DevTools (F12) → 控制台 (Console)，应看到类似日志：

```javascript
// 应用启动时
🚀 应用启动，初始化数据...

// authStore 初始化
✅ Auth 初始化成功
✓ 当前用户: [user_id]
✓ VIP 状态: [true/false]

// nodeStore 初始化
✅ 已加载 XX 个节点 (VIP用户看全部/非VIP用户只看20个)

// 极速注册成功
✅ 极速注册成功
[会显示自动登录信息]

// 激活码成功
✅ 激活码兑换成功: {...}
```

---

## 常见问题排查

### Q1: 点击登录按钮没反应
**检查清单**:
- [ ] 浏览器控制台是否有红色错误信息？
- [ ] AuthModal.vue 是否正确导入到 App.vue？
- [ ] 是否在 App.vue 中声明了 `authModalRef`？
- [ ] 修复：检查 App.vue 底部是否有 `<AuthModal ref="authModalRef" />`

### Q2: 显示"登录成功"但看不到用户名
**检查清单**:
- [ ] authStore.displayName 是否为空？
- [ ] Supabase Auth 用户是否有 user_metadata.username？
- [ ] 修复：确保注册时设置了 username 元数据

### Q3: VIP 徽章不显示
**检查清单**:
- [ ] authStore.isVip 是否为 true？
- [ ] Supabase profiles 表中是否有 vip_until 字段？
- [ ] vip_until 日期是否在当前日期之后？
- [ ] 修复：在 Supabase 控制台更新测试用户的 vip_until

### Q4: 极速注册后仍显示普通用户
**正常现象** - 极速注册不自动升级为 VIP，需要输入激活码

### Q5: 激活码兑换失败
**检查清单**:
- [ ] RPC 函数 `redeem_kami` 是否存在？
- [ ] 激活码是否有效？
- [ ] 控制台错误信息是什么？
- [ ] 修复：在 Supabase 控制台测试 RPC 函数

---

## 性能检查

打开 DevTools → Network，刷新页面：

- ✅ authStore.init() 应在 0.5-1s 内完成
- ✅ nodeStore.init() 应在 0.5-2s 内完成
- ✅ 登录请求应在 1-2s 内完成
- ✅ 激活码兑换应在 1-2s 内完成

---

## 🎯 测试检查清单

```
初始化测试:
☐ 游客模式：显示前20个节点
☐ 顶部导航栏显示"🔐 登录"按钮
☐ 无用户名或VIP徽章

极速注册测试:
☐ 点击"🚀 极速注册"生成账户
☐ 显示身份卡（用户名/密码/邮箱）
☐ 自动登录，显示"📌 普通用户"
☐ 节点仍限制为20个

邮箱注册测试:
☐ 输入邮箱/密码/用户名
☐ 注册成功，自动登录
☐ 显示正确的用户名

登录测试:
☐ 使用注册过的邮箱密码登录
☐ 成功登录，显示用户信息

激活码测试（需真实激活码）:
☐ 输入有效激活码
☐ 成功升级为VIP
☐ VIP徽章显示为"⭐ VIP"
☐ 节点列表显示全部（>20个）

登出测试:
☐ 点击"登出"按钮
☐ 登出成功，恢复游客状态
☐ 顶部显示"🔐 登录"
☐ 节点限制恢复为20个
```

---

## 🆘 获得帮助

如遇到问题，请检查：

1. **浏览器控制台** (F12 → Console)
   - 查看错误信息和日志
   - 记下完整的错误堆栈

2. **Supabase 控制台**
   - 验证 URL 和 API Key
   - 检查 profiles 表结构
   - 测试 RPC 函数

3. **前端代码**
   - authStore.js - 确保初始化正确
   - App.vue - 确保调用 authStore.init()
   - AuthModal.vue - 确保正确导入

---

**最后更新**: 2026-01-02  
**版本**: 1.0  
**状态**: 🟢 就绪测试
