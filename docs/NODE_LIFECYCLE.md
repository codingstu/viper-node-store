# èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸç®¡ç†

## æ¦‚è¿°

viper-node-store å®ç°äº†å®Œæ•´çš„èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬å»é‡ã€TTLç®¡ç†å’Œæ´»åŠ›éªŒè¯ã€‚ç¡®ä¿æ‰€æœ‰æä¾›ç»™ç”¨æˆ·çš„èŠ‚ç‚¹éƒ½æ˜¯æœ€æ–°ä¸”å¯ç”¨çš„ã€‚

---

## æ ¸å¿ƒç‰¹æ€§

### 1. è‡ªåŠ¨å»é‡ (Deduplication)

**å”¯ä¸€æ€§æ ‡å‡†**: `protocol + host + port`

```
ä¾‹å¦‚ï¼š
  http://127.0.0.1:8080
  https://proxy.example.com:9090
  socks5://192.168.1.1:1080
```

**å»é‡é€»è¾‘**:
- å½“SpiderFlowæ¨é€æ–°èŠ‚ç‚¹æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
- ç›¸åŒåè®®ã€ä¸»æœºã€ç«¯å£çš„èŠ‚ç‚¹è§†ä¸ºé‡å¤
- **ä¿ç•™ç­–ç•¥**: ä¿ç•™ç¬¬ä¸€æ¬¡å‘ç°çš„èŠ‚ç‚¹ï¼Œæ›´æ–°å…¶ `last_updated_at` æ—¶é—´æˆ³
- **æ—¶é—´æˆ³ç®¡ç†**:
  - `first_seen_at`: èŠ‚ç‚¹é¦–æ¬¡å‘ç°æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰
  - `last_updated_at`: èŠ‚ç‚¹æœ€åæ›´æ–°æ—¶é—´
  - æ°¸ä¸è¢«è¦†ç›– `first_seen_at`ï¼Œä»…æ›´æ–° `last_updated_at`

**å»é‡æ•°æ®ç»“æ„**:
```json
{
  "protocol": "http",
  "host": "127.0.0.1",
  "port": 8080,
  "first_seen_at": "2024-01-15T10:30:00",
  "last_updated_at": "2024-01-15T14:45:00",
  "is_stale": false
}
```

---

### 2. TTLç®¡ç† (Time-To-Live)

**TTLç­–ç•¥**: 3å¤©

èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸçš„å››ä¸ªé˜¶æ®µï¼š

#### é˜¶æ®µ1: æ–°å¢æœŸ (0-3å¤©)
- `age_days`: 0-2
- `needs_verification`: False
- ç›´æ¥æä¾›ç»™ç”¨æˆ·ï¼Œæ— éœ€éªŒè¯

#### é˜¶æ®µ2: éªŒè¯æœŸ (3å¤©ä»¥ä¸Š)
- `age_days`: â‰¥3
- `needs_verification`: True
- æ ‡è®°ä¸ºå¾…éªŒè¯ï¼Œä¸ç›´æ¥æä¾›ç»™å®¢æˆ·ç«¯ï¼ˆå¯é€‰çš„åç«¯è¿‡æ»¤ï¼‰
- ç­‰å¾…å®šæ—¶éªŒè¯ä»»åŠ¡æ£€æŸ¥è¿é€šæ€§

#### é˜¶æ®µ3: éªŒè¯ä¸­
- æ¯å¤©å‡Œæ™¨2:00æ‰§è¡Œå®šæ—¶éªŒè¯
- æ‰§è¡ŒTCP HEADè¯·æ±‚åˆ° `https://www.cloudflare.com/`
- éªŒè¯é€šè¿‡æ›´æ–° `last_verified_at`
- éªŒè¯å¤±è´¥è®¾ç½® `offline_status=True`

#### é˜¶æ®µ4: æ¸…ç†æœŸ (ç¦»çº¿>7å¤©)
- èŠ‚ç‚¹ç¦»çº¿è¶…è¿‡7å¤©è‡ªåŠ¨åˆ é™¤
- ä¾æ®: `verification_failed_at` åˆ°å½“å‰æ—¶é—´çš„å¤©æ•° > 7

**èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸå­—æ®µ**:
```json
{
  "age_days": 5,
  "needs_verification": true,
  "last_verified_at": "2024-01-15T02:00:00",
  "offline_status": false,
  "verification_failed_at": null,
  "should_delete": false
}
```

---

### 3. æ•°æ®åŒæ­¥

#### åŒæ­¥æ–¹å¼

**WebhookåŒæ­¥ (å®æ—¶)**
- SpiderFlowä¸»åŠ¨æ¨é€æ•°æ®åˆ° `/webhook/nodes`
- ä¼˜å…ˆçº§æœ€é«˜
- ç«‹å³æ‰§è¡Œå»é‡å’Œåˆå¹¶

**è½®è¯¢åŒæ­¥ (æ¯5åˆ†é’Ÿ)**
- å‘SpiderFlowæŸ¥è¯¢ `/nodes/export?format=json`
- ä½œä¸ºWebhookçš„å¤‡ç”¨æœºåˆ¶
- æ‰§è¡Œå»é‡å’Œåˆå¹¶
- å¯¹æ¯”å“ˆå¸Œï¼Œä»…åœ¨æ•°æ®æœ‰å˜æ›´æ—¶æ›´æ–°

#### åˆå¹¶ç­–ç•¥

å½“è¿œç¨‹æ•°æ®ä¸æœ¬åœ°æ•°æ®åˆå¹¶æ—¶ï¼š

1. **è¿œç¨‹èŠ‚ç‚¹ä¼˜å…ˆ**
   - è¿œç¨‹æœ‰çš„èŠ‚ç‚¹æ›´æ–° `last_updated_at`
   - ä¿ç•™ `first_seen_at` ä¸å˜

2. **æœ¬åœ°ç‹¬æœ‰èŠ‚ç‚¹**
   - æ ‡è®°ä¸º `is_stale=True`
   - ç­‰å¾…éªŒè¯æˆ–åˆ é™¤

3. **ç»“æœ**
   - æœ¬åœ°èŠ‚ç‚¹æ•° = æ´»è·ƒèŠ‚ç‚¹æ•° (ä¸å«stale) + staleèŠ‚ç‚¹æ•°

#### åŒæ­¥å…ƒæ•°æ®

```json
{
  "sync_metadata": {
    "total_count": 150,
    "active_count": 145,
    "needs_verification": 12,
    "deduplicated": 3,
    "remote_timestamp": "2024-01-15T14:45:00"
  }
}
```

---

### 4. æ´»åŠ›æ£€æŸ¥

#### éªŒè¯æœºåˆ¶

**æ‰§è¡Œæ—¶é—´**: æ¯å¤©å‡Œæ™¨2:00 (å¯é…ç½®)

**éªŒè¯æ–¹æ³•**:
- é€šè¿‡ä»£ç†è®¿é—® `https://www.cloudflare.com/`
- HTTP HEADè¯·æ±‚
- è¶…æ—¶è®¾ç½®: 5ç§’
- çŠ¶æ€ç  < 500 è§†ä¸ºå¯è¾¾

**éªŒè¯æµç¨‹**:
```python
# ä¼ªä»£ç 
for node in nodes_needing_verification:
    if await is_reachable(node):
        node.last_verified_at = now()
        node.offline_status = False
    else:
        node.offline_status = True
        node.verification_failed_at = now()
        
        # æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ é™¤
        if now() - node.verification_failed_at > 7_days:
            delete(node)
```

#### å¤±è´¥å¤„ç†

- **é¦–æ¬¡å¤±è´¥**: æ ‡è®° `offline_status=True`ï¼Œè®°å½• `verification_failed_at`
- **è¿ç»­å¤±è´¥**: ç»§ç»­æ ‡è®°ä½†ä¿ç•™èŠ‚ç‚¹
- **7å¤©ç¦»çº¿**: è‡ªåŠ¨åˆ é™¤èŠ‚ç‚¹
- **é‡æ–°ä¸Šçº¿**: è®¿é—®æˆåŠŸæ—¶æ¸…é™¤ç¦»çº¿æ ‡è®°

---

## APIæ¥å£

### GET /api/sync-info

è·å–åŒæ­¥ä¿¡æ¯ç”¨äºå‰ç«¯æ˜¾ç¤º

**å“åº”ç¤ºä¾‹**:
```json
{
  "last_updated_at": "2024-01-15T14:45:23",
  "minutes_ago": 5,
  "nodes_count": 150,
  "active_count": 145,
  "source": "webhook",
  "needs_verification": 12,
  "sync_metadata": {
    "total_count": 150,
    "active_count": 145,
    "deduplicated": 3
  }
}
```

### GET /api/nodes

è·å–èŠ‚ç‚¹åˆ—è¡¨

**æŸ¥è¯¢å‚æ•°**:
- `limit`: è¿”å›èŠ‚ç‚¹æ•°é‡é™åˆ¶
- `filter`: å¯é€‰ï¼Œè¿‡æ»¤æ¡ä»¶ï¼ˆå¦‚ `active` ä»…è¿”å›activeèŠ‚ç‚¹ï¼‰

**å“åº”æ ¼å¼**: èŠ‚ç‚¹æ•°ç»„JSON

---

## æ•°æ®æ ¼å¼

### èŠ‚ç‚¹æ•°æ®ç»“æ„

```json
{
  "id": "unique-id-auto-generated",
  "protocol": "http",
  "host": "proxy.example.com",
  "port": 8080,
  "username": "user",
  "password": "pass",
  "proxy_url": "http://user:pass@proxy.example.com:8080",
  
  "first_seen_at": "2024-01-13T08:30:00",
  "last_updated_at": "2024-01-15T14:45:23",
  "last_verified_at": "2024-01-15T02:15:00",
  
  "age_days": 2,
  "is_stale": false,
  "offline_status": false,
  "needs_verification": false,
  "verification_failed_at": null,
  "should_delete": false,
  
  "latency": 150,
  "speed": 45.6,
  "mainland_score": 95,
  "mainland_latency": 120
}
```

### å­˜å‚¨æ–‡ä»¶

**verified_nodes.json**
```json
{
  "nodes": [...],
  "last_synced_from": "webhook | poll",
  "last_synced_at": "ISOæ—¶é—´æˆ³",
  "nodes_count": 145,
  "last_verified_at": "ISOæ—¶é—´æˆ³",
  "sync_metadata": {
    "total_count": 150,
    "active_count": 145,
    "needs_verification": 12,
    "deduplicated": 3
  }
}
```

---

## é…ç½®

### ç¯å¢ƒå˜é‡

```bash
# SpiderFlow APIåœ°å€
SPIDERFLOW_API_URL=http://localhost:8001

# è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
POLL_INTERVAL=300

# èŠ‚ç‚¹TTLï¼ˆå¤©ï¼‰
NODE_TTL=3

# æœ€å¤§ç¦»çº¿å¤©æ•°ï¼ˆå¤©ï¼‰
MAX_OFFLINE_DAYS=7
```

### å®šæ—¶ä»»åŠ¡é…ç½®

**èŠ‚ç‚¹éªŒè¯å®šæ—¶ä»»åŠ¡**:
```python
# æ‰§è¡Œæ—¶é—´: æ¯å¤©å‡Œæ™¨2:00 (Asia/Shanghaiæ—¶åŒº)
CronTrigger(hour=2, minute=0, timezone='Asia/Shanghai')
```

---

## ç›‘æ§æŒ‡æ ‡

### åŒæ­¥çŠ¶æ€ç›‘æ§

é€šè¿‡å‰ç«¯é¡µé¢é¡¶éƒ¨"åŒæ­¥çŠ¶æ€æ¨ªå¹…"æ˜¾ç¤ºï¼š
- ä¸Šæ¬¡æ›´æ–°æ—¶é—´ (ç›¸å¯¹æ—¶é—´: "5åˆ†é’Ÿå‰")
- æ´»è·ƒèŠ‚ç‚¹æ•°é‡
- æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®

### æ—¥å¿—è®°å½•

**å…³é”®æ“ä½œæ—¥å¿—**:
```
âœ… å»é‡å®Œæˆ: å‘ç°3ä¸ªé‡å¤èŠ‚ç‚¹
ğŸ“¥ ä»SpiderFlowè·å–150ä¸ªèŠ‚ç‚¹
ğŸ”€ åˆå¹¶ç»“æœ: æœ¬åœ°100 + è¿œç¨‹150 = 245ä¸ªèŠ‚ç‚¹
â¬†ï¸ æ›´æ–°èŠ‚ç‚¹ http://127.0.0.1:8080
ğŸ‘» æ ‡è®°æœ¬åœ°ç‹¬æœ‰èŠ‚ç‚¹ä¸ºè¿‡æœŸ
âœ¨ æ–°å¢èŠ‚ç‚¹ http://proxy.example.com:8080
ğŸ” æ‰¹é‡éªŒè¯å®Œæˆ | æ€»è®¡12ä¸ª | å¤±è´¥3ä¸ª
âœ… èŠ‚ç‚¹éªŒè¯é€šè¿‡: http://127.0.0.1:8080
âŒ èŠ‚ç‚¹éªŒè¯å¤±è´¥: http://proxy.example.com:8080
ğŸ—‘ï¸ æ ‡è®°åˆ é™¤é•¿æœŸç¦»çº¿èŠ‚ç‚¹: http://old.proxy:1080 | ç¦»çº¿8å¤©
```

---

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯1: æ–°èŠ‚ç‚¹é¦–æ¬¡åŒæ­¥

```
æ—¶é—´ç‚¹: 2024-01-15 10:00
æ“ä½œ:
1. SpiderFlowæ¨é€10ä¸ªæ–°èŠ‚ç‚¹
2. ç³»ç»Ÿæ‰§è¡Œå»é‡: 0ä¸ªé‡å¤ï¼Œ10ä¸ªæ–°å¢
3. ç³»ç»Ÿæ‰§è¡Œåˆå¹¶: æ–°å¢first_seen_atå’Œlast_updated_at
4. èŠ‚ç‚¹çŠ¶æ€: age_days=0, needs_verification=False
5. ç”¨æˆ·å¯ç”¨: âœ… ç«‹å³æä¾›ç»™å®¢æˆ·ç«¯
```

### åœºæ™¯2: é‡å¤èŠ‚ç‚¹åŒæ­¥

```
æ—¶é—´ç‚¹: 2024-01-15 15:00 (5å°æ—¶å)
æ“ä½œ:
1. SpiderFlowæ¨é€èŠ‚ç‚¹ (åŒ…å«5å°æ—¶å‰çš„æŸä¸ªèŠ‚ç‚¹)
2. ç³»ç»Ÿæ‰§è¡Œå»é‡: æ£€æµ‹åˆ°é‡å¤ (protocol+host:portåŒ¹é…)
3. ä¿ç•™ç­–ç•¥:
   - first_seen_at: 2024-01-15 10:00 (ä¿æŒä¸å˜)
   - last_updated_at: 2024-01-15 15:00 (æ›´æ–°)
4. åˆå¹¶: è¦†ç›–å…¶ä»–å­—æ®µï¼Œä½†first_seen_atä¸å˜
```

### åœºæ™¯3: 3å¤©åéªŒè¯

```
æ—¶é—´ç‚¹: 2024-01-18 02:00 (3å¤©åå®šæ—¶éªŒè¯)
èŠ‚ç‚¹çŠ¶æ€å‰: age_days=3, needs_verification=True
æ“ä½œ:
1. å®šæ—¶ä»»åŠ¡å¯åŠ¨
2. é€‰æ‹©æ‰€æœ‰éœ€è¦éªŒè¯çš„èŠ‚ç‚¹
3. æ‰§è¡ŒTCP HEADè¯·æ±‚åˆ°cloudflare.com
4. ç»“æœA (æˆåŠŸ):
   - offline_status=False
   - last_verified_at=2024-01-18 02:00:00
5. ç»“æœB (å¤±è´¥):
   - offline_status=True
   - verification_failed_at=2024-01-18 02:00:00
   - ç»§ç»­ç­‰å¾…7å¤©ååˆ é™¤
```

### åœºæ™¯4: 7å¤©åæ¸…ç†

```
æ—¶é—´ç‚¹: 2024-01-25 02:00 (å¤±è´¥å7å¤©)
èŠ‚ç‚¹çŠ¶æ€: offline_status=True, verification_failed_at=2024-01-18 02:00:00
æ“ä½œ:
1. å®šæ—¶ä»»åŠ¡æ£€æŸ¥ç¦»çº¿æ—¶é•¿: 7å¤©
2. åˆ¤æ–­: should_delete=True
3. ä»æœ¬åœ°æ•°æ®åº“åˆ é™¤è¯¥èŠ‚ç‚¹
4. æ—¥å¿—: "ğŸ—‘ï¸ æ ‡è®°åˆ é™¤é•¿æœŸç¦»çº¿èŠ‚ç‚¹ ... | ç¦»çº¿7å¤©"
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: å»é‡ä¸å·¥ä½œ

**ç—‡çŠ¶**: ç›¸åŒIP:ç«¯å£çš„èŠ‚ç‚¹å‡ºç°å¤šæ¡

**æ’æŸ¥**:
1. æ£€æŸ¥ `protocol` å­—æ®µæ˜¯å¦éƒ½å­˜åœ¨
2. ç¡®è®¤ `host` æ ¼å¼ä¸€è‡´ (å¤§å°å†™ã€æ˜¯å¦æœ‰ç©ºæ ¼)
3. ç¡®è®¤ `port` æ˜¯æ•°å­—è€Œéå­—ç¬¦ä¸²
4. æ£€æŸ¥ `get_node_unique_key()` å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨

### é—®é¢˜2: TTLéªŒè¯å¤±è´¥

**ç—‡çŠ¶**: 3å¤©+çš„èŠ‚ç‚¹ä»æ ‡è®°ä¸º `needs_verification=False`

**æ’æŸ¥**:
1. æ£€æŸ¥ `first_seen_at` æ˜¯å¦ä¸ºæœ‰æ•ˆISOæ—¶é—´æˆ³
2. éªŒè¯ `calculate_node_age()` é€»è¾‘
3. æ£€æŸ¥ `apply_node_lifecycle()` æ˜¯å¦åœ¨åŒæ­¥æµç¨‹ä¸­è¢«è°ƒç”¨
4. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿— "æ ‡è®°å¾…éªŒè¯èŠ‚ç‚¹"

### é—®é¢˜3: å®šæ—¶éªŒè¯ä¸æ‰§è¡Œ

**ç—‡çŠ¶**: æ—¥å¿—æ—  "å¼€å§‹å®šæ—¶èŠ‚ç‚¹éªŒè¯ä»»åŠ¡" ä¿¡æ¯

**æ’æŸ¥**:
1. æ£€æŸ¥APScheduleræ˜¯å¦å¯åŠ¨: `scheduler.running`
2. éªŒè¯ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£ç¡® (å®šæ—¶ä»»åŠ¡éœ€è¦æ­£ç¡®çš„ç³»ç»Ÿæ—¶é—´)
3. æŸ¥çœ‹åº”ç”¨å¯åŠ¨æ—¥å¿—: "èŠ‚ç‚¹éªŒè¯å®šæ—¶å™¨å·²å¯åŠ¨"
4. æ£€æŸ¥æ—¶åŒºè®¾ç½®æ˜¯å¦ä¸º `Asia/Shanghai`

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ‰¹é‡éªŒè¯**: ä½¿ç”¨å¼‚æ­¥å¹¶å‘æ§åˆ¶ï¼Œé¿å…åŒæ—¶éªŒè¯è¿‡å¤šèŠ‚ç‚¹
2. **ç¼“å­˜hash**: å­˜å‚¨ä¸Šæ¬¡çš„å“ˆå¸Œå€¼ï¼Œå‡å°‘ä¸å¿…è¦çš„æ•°æ®æ›´æ–°
3. **åˆ†é¡µæŸ¥è¯¢**: å¤§è§„æ¨¡èŠ‚ç‚¹æ—¶ä½¿ç”¨åˆ†é¡µ
4. **å¼‚æ­¥éªŒè¯**: ä½¿ç”¨ `asyncio` å¹¶å‘æ‰§è¡ŒéªŒè¯

---

## ç‰ˆæœ¬å†å²

- **v1.0** (2024-01-15): åˆå§‹å®ç°
  - èŠ‚ç‚¹å»é‡ (protocol+host:port)
  - TTLç®¡ç† (3å¤©éªŒè¯)
  - æ´»åŠ›æ£€æŸ¥ (æ¯å¤©2:00)
  - è‡ªåŠ¨æ¸…ç† (7å¤©ç¦»çº¿åˆ é™¤)
