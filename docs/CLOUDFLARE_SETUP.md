# Cloudflare Workers å›½å¤–æµ‹é€Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è§ˆ

æœ¬é¡¹ç›®ä½¿ç”¨ **Cloudflare Workers** ä¸º **å›å›½èŠ‚ç‚¹** è¿›è¡Œå›½å¤–ç½‘ç»œæµ‹é€Ÿï¼Œç¡®ä¿è¿™äº›èŠ‚ç‚¹åœ¨å›½å¤–ç”¨æˆ·èƒ½å¤Ÿä½¿ç”¨ã€‚

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1ï¸âƒ£ ç™»å½• Cloudflare Dashboard

è®¿é—® https://dash.cloudflare.comï¼Œä½¿ç”¨ä½ çš„è´¦å·ç™»å½•ã€‚

### 2ï¸âƒ£ åˆ›å»º Workers é¡¹ç›®

1. ç‚¹å‡»å·¦ä¾§èœå•çš„ **"Workers and Pages"**
2. ç‚¹å‡» **"Create application"** > **"Create a Worker"**
3. å‘½åä¸º `mainland-node-overseas-probe` æˆ–ä½ å–œæ¬¢çš„åç§°
4. ç‚¹å‡» **"Deploy"**

### 3ï¸âƒ£ éƒ¨ç½²ä»£ç 

1. ç‚¹å‡» **"Edit code"**ï¼ˆæˆ–åœ¨åˆ—è¡¨ä¸­å³é”® â†’ Editï¼‰
2. æ¸…ç©ºé»˜è®¤ä»£ç 
3. **å¤åˆ¶ç²˜è´´** é¡¹ç›®ä¸­çš„ [cloudflare_worker.js](./cloudflare_worker.js) å…¨éƒ¨å†…å®¹
4. ç‚¹å‡» **"Save and Deploy"**

### 4ï¸âƒ£ è·å– Worker URL

éƒ¨ç½²æˆåŠŸåï¼Œä½ å°†çœ‹åˆ° Worker URLï¼Œæ ¼å¼å¦‚ï¼š
```
https://mainland-node-overseas-probe.your-account.workers.dev
```

**å¤åˆ¶è¿™ä¸ª URL**ï¼Œç¨åéœ€è¦æ·»åŠ åˆ° GitHub Secretsã€‚

---

## ğŸ”‘ é…ç½® GitHub Secrets

1. è¿›å…¥ä½ çš„ GitHub ä»“åº“
2. **Settings** > **Secrets and variables** > **Actions**
3. ç‚¹å‡» **"New repository secret"**
4. åç§°ï¼š`CLOUDFLARE_WORKER_URL`
5. å€¼ï¼šç²˜è´´ä¸Šé¢è·å¾—çš„ Worker URL
6. ç‚¹å‡» **"Add secret"**

---

## ğŸ§ª æµ‹è¯• Worker

### ä½¿ç”¨ cURL æµ‹è¯•

```bash
curl -X POST https://mainland-node-overseas-probe.your-account.workers.dev \
  -H "Content-Type: application/json" \
  -d '{
    "nodes": [
      {
        "id": "test-node-1",
        "host": "1.1.1.1",
        "port": 443
      }
    ]
  }'
```

### é¢„æœŸå“åº”

```json
[
  {
    "id": "test-node-1",
    "host": "1.1.1.1",
    "port": 443,
    "latency": 25,
    "success": true,
    "region": "Global"
  }
]
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### æµ‹é€Ÿæµç¨‹

```
GitHub Actions (æ¯ 4 å°æ—¶è¿è¡Œ)
    â†“
1ï¸âƒ£ fetch_nodes_from_api() - è·å–åŸå§‹èŠ‚ç‚¹
    â†“
2ï¸âƒ£ æŒ‰å›½å®¶åˆ†ç±»
    â”œâ”€â”€ ğŸ‡¨ğŸ‡³ CN èŠ‚ç‚¹ â†’ test_nodes_via_aliyun() â†’ Aliyun FC å¤§é™†æµ‹é€Ÿ
    â””â”€â”€ ğŸŒ é CN èŠ‚ç‚¹ â†’ test_nodes_via_cloudflare() â†’ Cloudflare Workers å›½å¤–æµ‹é€Ÿ
    â†“
3ï¸âƒ£ save_to_supabase() - åˆå¹¶ç»“æœä¿å­˜æ•°æ®åº“
    â†“
ğŸŒ å‰ç«¯ (index.html) - åˆ·æ–°æ˜¾ç¤ºæœ€æ–°èŠ‚ç‚¹
```

### èŠ‚ç‚¹åˆ†ç±»è§„åˆ™

| å›½å®¶ä»£ç  | åˆ†ç±» | æµ‹é€Ÿæ–¹å¼ |
|---------|------|---------|
| `CN` | å¤§é™† | âš™ï¸ Aliyun FC (æ­å·/ä¸Šæµ·) |
| `HK`, `TW`, `MO` | å›å›½ | ğŸŒ Cloudflare Workers |
| å…¶ä»– | å›½å¤– | ğŸŒ Cloudflare Workers |
| æ— æ ‡è®° | é»˜è®¤å›½å¤– | ğŸŒ Cloudflare Workers |

---

## ğŸ“Š æµ‹é€Ÿè¯„åˆ†æ ‡å‡†

### å¤§é™†èŠ‚ç‚¹ (Aliyun FC)
- **< 50ms** â†’ 50 åˆ† (æé€Ÿ CN2/ä¸“çº¿)
- **< 100ms** â†’ 30 åˆ† (ä¼˜ç§€ äºšå¤ªç›´è¿)
- **< 200ms** â†’ 10 åˆ† (æ­£å¸¸ ç¾è¥¿ç›´è¿)
- **< 350ms** â†’ 3 åˆ† (ä¸€èˆ¬ æ™®é€šçº¿è·¯)
- **â‰¥ 350ms** â†’ 1 åˆ† (è¾ƒå·® ç»•è·¯)

### å›½å¤–èŠ‚ç‚¹ (Cloudflare Workers)
- **< 100ms** â†’ 50 åˆ† (æé€Ÿ è·ç¦»è¿‘/ä¸“çº¿)
- **< 150ms** â†’ 30 åˆ† (ä¼˜ç§€)
- **< 250ms** â†’ 10 åˆ† (æ­£å¸¸)
- **< 400ms** â†’ 3 åˆ† (ä¸€èˆ¬)
- **â‰¥ 400ms** â†’ 1 åˆ† (è¾ƒå·®)

---

## â“ å¸¸è§é—®é¢˜

### Q: Worker è¶…æ—¶äº†æ€ä¹ˆåŠï¼Ÿ
**A:** Cloudflare Workers é»˜è®¤è¶…æ—¶ 30sï¼Œæœ¬è„šæœ¬ä¸­æ¯ä¸ªèŠ‚ç‚¹è¶…æ—¶ 2.5sï¼Œç†è®ºä¸Šå¯åŒæ—¶æµ‹è¯• 12 ä¸ªèŠ‚ç‚¹ã€‚å¦‚æœè¶…æ—¶ï¼š
- æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦çœŸçš„åœ¨çº¿
- å‡å° `batch_size`ï¼ˆåœ¨ update_nodes.py ä¸­æ”¹ä¸º 10ï¼‰
- æ£€æŸ¥ç½‘ç»œè¿æ¥

### Q: ä¸ºä»€ä¹ˆæŸäº›èŠ‚ç‚¹æ˜¾ç¤º latency = -1ï¼Ÿ
**A:** è¿™è¡¨ç¤ºæµ‹é€Ÿå¤±è´¥ï¼ˆæ— æ³•è¿æ¥ï¼‰ã€‚è¯¥èŠ‚ç‚¹åœ¨å›½å¤–ç½‘ç»œä¸­ä¸å¯è¾¾ï¼Œä¼šè¢«è‡ªåŠ¨å‰”é™¤ã€‚

### Q: èƒ½å¦åŒæ—¶ä½¿ç”¨å¤šä¸ª Cloudflare Workersï¼Ÿ
**A:** å¯ä»¥ï¼å°†å¤šä¸ª Worker URL ç”¨é€—å·åˆ†éš”ï¼Œè½®æµå‘é€èŠ‚ç‚¹ã€‚ï¼ˆéœ€è¦ä¿®æ”¹ Python ä»£ç ï¼‰

### Q: éœ€è¦ Cloudflare ä»˜è´¹ï¼Ÿ
**A:** **ä¸éœ€è¦**ã€‚Cloudflare Workers å…è´¹é¢åº¦ï¼š
- æ¯å¤© 10 ä¸‡æ¬¡è¯·æ±‚
- æœ¬é¡¹ç›®æ¯ 4 å°æ—¶æœ€å¤šæµ‹è¯•æ•°ç™¾ä¸ªèŠ‚ç‚¹ï¼Œè¿œåœ¨å…è´¹é¢åº¦å†…

---

## ğŸ” ç›‘æ§ä¸è°ƒè¯•

### æŸ¥çœ‹ Worker æ—¥å¿—

1. Cloudflare Dashboard â†’ Workers â†’ ä½ çš„ Worker
2. ç‚¹å‡» **"Logs"** æ ‡ç­¾é¡µ
3. æŸ¥çœ‹å®æ—¶è¯·æ±‚æ—¥å¿—

### å¸¸è§é”™è¯¯ä¿¡æ¯

| é”™è¯¯ | åŸå›  | è§£å†³ |
|-----|------|------|
| `Method not allowed` | ä½¿ç”¨äº† GET è€Œä¸æ˜¯ POST | ç¡®ä¿è„šæœ¬å‘é€ POST è¯·æ±‚ |
| `No nodes provided` | JSON ä¸­æ²¡æœ‰ `nodes` å­—æ®µ | æ£€æŸ¥ Python è„šæœ¬ä¸­çš„ payload ç»“æ„ |
| `timeout` | èŠ‚ç‚¹æ— æ³•è¿æ¥ | è¯¥èŠ‚ç‚¹åœ¨å›½å¤–ç½‘ç»œä¸­ä¸å¯è¾¾ |
| `ParseError` | JSON è§£æå¤±è´¥ | æ£€æŸ¥ Python è„šæœ¬å‘é€çš„ JSON æ ¼å¼ |

---

## ğŸ“ æ›´æ–° Python è„šæœ¬

å·²è‡ªåŠ¨åŒ…å«åœ¨ `update_nodes.py` ä¸­ï¼š

```python
# ä»ç¯å¢ƒå˜é‡è¯»å– Cloudflare Worker URL
CLOUDFLARE_WORKER_URL = os.environ.get("CLOUDFLARE_WORKER_URL", "")

# åœ¨ main() ä¸­è‡ªåŠ¨åˆ†ç±»å’Œæµ‹é€Ÿ
if overseas_nodes:
    cf_results = await test_nodes_via_cloudflare(overseas_nodes)
    all_valid_nodes.extend(cf_results)
```

---

## âœ… éªŒè¯éƒ¨ç½²

è¿è¡Œ GitHub Actions å·¥ä½œæµï¼š

1. è¿›å…¥ä»“åº“ **Actions** æ ‡ç­¾é¡µ
2. é€‰æ‹© **"Update & Test Nodes"**
3. ç‚¹å‡» **"Run workflow"** > **"Run workflow"**
4. ç­‰å¾…å®Œæˆï¼Œæ£€æŸ¥æ—¥å¿—

æ—¥å¿—ä¸­åº”æ˜¾ç¤ºï¼š
```
ğŸš€ [2B/3] å¯åŠ¨å›½å¤–æµ‹é€Ÿ (Cloudflare Workers)...
   ğŸ“¤ å‘é€æ‰¹æ¬¡ 1 (15 ä¸ªèŠ‚ç‚¹)...
   âœ… 1.2.3.4 | å»¶è¿Ÿ: 45ms (å›½å¤–çœŸå®)
âœ… å›½å¤–æµ‹é€Ÿå®Œæˆ: X / Y ä¸ªèŠ‚ç‚¹åœ¨å›½å¤–å¯ç”¨
```

---

## ğŸ¯ æ€»ç»“

| æ­¥éª¤ | å®Œæˆ |
|-----|-----|
| 1. éƒ¨ç½² Cloudflare Worker | âœ… å®Œæˆ (è§ä¸Šæ–¹) |
| 2. å¤åˆ¶ Worker URL | â³ éœ€è¦æ‰‹åŠ¨ |
| 3. æ·»åŠ  GitHub Secret | â³ éœ€è¦æ‰‹åŠ¨ |
| 4. Python è„šæœ¬é›†æˆ | âœ… å·²å®Œæˆ |
| 5. å‰ç«¯ç¼“å­˜ä¿®å¤ | âœ… å·²å®Œæˆ |
| 6. æµ‹è¯•å¹¶éªŒè¯ | â³ éœ€è¦æ‰‹åŠ¨ |

---

**å‡†å¤‡å¥½äº†ï¼Ÿç°åœ¨å°±[éƒ¨ç½² Cloudflare Worker](#éƒ¨ç½²æ­¥éª¤) å§ï¼** ğŸš€
