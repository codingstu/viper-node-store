name: Update & Test Nodes

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'update_nodes.py'
      - '.github/workflows/update-nodes.yml'

permissions:
  contents: write

jobs:
  update-nodes:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp supabase requests aiodns
      
      - name: Export nodes from API
        env:
          SHADOW_VIPER_API: ${{ secrets.SHADOW_VIPER_API }}
        run: |
          python << 'EOF'
          import requests
          import json
          import os
          
          api_url = os.environ.get("SHADOW_VIPER_API", "")
          if not api_url:
              print("âš ï¸ SHADOW_VIPER_API æœªè®¾ç½®ï¼Œè·³è¿‡èŠ‚ç‚¹å¯¼å‡º")
              exit(0)
          
          try:
              print(f"ðŸ“¡ ä»Ž API å¯¼å‡ºèŠ‚ç‚¹: {api_url[:50]}...")
              response = requests.get(api_url, timeout=60)
              if response.status_code == 200:
                  nodes = response.json()
                  os.makedirs('public', exist_ok=True)
                  with open('public/nodes.json', 'w', encoding='utf-8') as f:
                      json.dump(nodes, f, ensure_ascii=False, indent=2)
                  print(f"âœ… å¯¼å‡ºæˆåŠŸ: {len(nodes)} ä¸ªèŠ‚ç‚¹")
              else:
                  print(f"âŒ API è¿”å›žé”™è¯¯: {response.status_code}")
          except Exception as e:
              print(f"âŒ å¯¼å‡ºå¤±è´¥: {e}")
          EOF
      
      - name: Run node testing script
        env:
          SHADOW_VIPER_API: ${{ secrets.SHADOW_VIPER_API }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ALIYUN_FC_URL: ${{ secrets.ALIYUN_FC_URL }}
          ALIYUN_SECRET: ${{ secrets.ALIYUN_SECRET }}
          CLOUDFLARE_WORKER_URL: ${{ secrets.CLOUDFLARE_WORKER_URL }}
        run: python update_nodes.py
      
      - name: Commit updated nodes.json
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/nodes.json
          git diff --staged --quiet || git commit -m "chore: auto-update nodes.json"
          git push || echo "Nothing to push"
